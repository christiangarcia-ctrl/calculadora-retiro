<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#0B5ED7; 
    --brand-2:#084cc3;
    --ink:#0f172a; 
    --muted:#94a3b8;
    --paper:#111827; 
    --panel:#0b1324; 
    --line:rgba(255,255,255,.14);
    --wa:#25D366;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,#0b1223,#121a2f);
    color:#e5e7eb;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1040px;margin:0 auto;padding:22px}

  /* Header */
  .header{
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:16px 18px;
    display:flex;
    align-items:center;
    gap:14px;
    box-shadow:0 8px 24px rgba(15,23,42,.16)
  }
  .brand img{height:56px;width:auto;display:block}
  .title{font-weight:800;font-size:22px;color:#0f172a}
  .sub{font-size:13px;color:#475569}
  .meta{
    margin-left:auto;
    text-align:right;
    font-size:14px;
    color:#111827;
    display:flex;
    gap:24px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .meta span{display:flex;gap:8px;align-items:center}

  /* Toolbar */
  .toolbar{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin:14px 0 18px
  }
  .btn{
    appearance:none;
    border:1px solid #e5e7eb;
    background:#fff;
    color:#0f172a;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    transition:.2s
  }
  .btn:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 18px rgba(2,6,23,.10)
  }
  .btn-primary{
    background:var(--brand);
    border-color:var(--brand);
    color:#fff
  }
  .btn-primary:hover{background:var(--brand-2)}

  /* Banner */
  .banner{
    background:#fff7ed;
    color:#7c2d12;
    border:1px solid #fed7aa;
    border-left:6px solid #fb923c;
    border-radius:14px;
    padding:14px 16px;
    margin:18px 0;
    box-shadow:0 4px 14px rgba(2,6,23,.12)
  }
  .banner strong{color:#9a3412}

  /* Cards */
  .card{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    border-radius:16px;
    padding:22px;
    margin:16px 0
  }
  .card h2{
    margin:0 0 10px;
    color:#dbe3f3;
    font-size:20px;
    font-weight:800
  }
  .help{margin:-2px 0 14px;color:#cbd5e1;font-size:13px}

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:14px
  }
  .group{display:flex;flex-direction:column}
  label{font-size:12px;color:#cbd5e1;margin-bottom:6px;font-weight:600}
  input,select{
    padding:12px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);
    color:#fff;
    border-radius:10px;
    font-size:16px;
    transition:border .15s, box-shadow .15s
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(11,94,215,.25)
  }
  .muted{font-size:12px;color:#94a3b8;margin-top:6px}

  /* Suggestion */
  .suggest{
    display:none;
    border:1px solid rgba(11,94,215,.35);
    background:linear-gradient(0deg,rgba(11,94,215,.10),rgba(11,94,215,.10));
    border-left:6px solid var(--brand);
    border-radius:14px;
    padding:14px;
    margin-top:12px
  }
  .suggest strong{color:#eaf2ff}

  /* KPIs */
  .kpis{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
    margin-top:6px
  }
  .kpi{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    border-radius:14px;
    padding:16px
  }
  .kpi-label{
    font-size:11px;
    letter-spacing:.4px;
    color:#a9b4c7;
    text-transform:uppercase
  }
  .kpi-value{
    font-size:22px;
    font-weight:800;
    color:#f8fafc
  }

  /* Details tables */
  .toggle{
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    border:1px solid var(--line);
    padding:12px 14px;
    border-radius:12px;
    margin-top:10px
  }
  .details{display:none;overflow:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th{
    background:rgba(255,255,255,.08);
    text-align:left;
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.14);
    font-size:13px
  }
  td{
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.08);
    font-size:14px
  }

  /* Lectura estrat√©gica */
  .strategic-block{
    margin-top:18px;
    border-radius:14px;
    border:1px dashed rgba(148,163,184,.7);
    padding:14px 16px;
    background:rgba(15,23,42,.55);
  }
  .strategic-block h3{
    margin:0 0 6px;
    font-size:16px;
    font-weight:800;
    color:#e5e7eb;
  }
  .strategic-block p{
    margin:4px 0;
    font-size:13px;
    color:#cbd5e1;
  }
  .strategic-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
    font-size:13px;
  }
  .strategic-table th,
  .strategic-table td{
    border:1px solid rgba(148,163,184,.4);
    padding:6px 8px;
    text-align:right;
  }
  .strategic-table th:first-child,
  .strategic-table td:first-child{
    text-align:left;
  }
  .strategic-note{
    margin-top:6px;
    font-size:12px;
    color:#9ca3af;
  }

  /* WhatsApp */
  .wa{
    position:fixed;
    right:18px;
    bottom:22px;
    background:var(--wa);
    color:#06371a;
    border-radius:999px;
    padding:12px 16px;
    font-weight:800;
    box-shadow:0 10px 24px rgba(0,0,0,.25)
  }

  .error{
    display:none;
    background:rgba(220,53,69,.18);
    border:1px solid rgba(220,53,69,.4);
    color:#fecaca;
    padding:10px;
    border-radius:10px;
    margin:8px 0
  }

  /* Print */
  @media print{
    body{
      background:#ffffff;
      color:#000000;
    }
    .wa,
    .toolbar,
    .toggle{
      display:none!important;
    }
    .header{
      box-shadow:none;
      border-color:#d1d5db;
    }
    .card{
      background:#ffffff;
      border-color:#d1d5db;
      box-shadow:none;
    }
    .banner{
      background:#f9fafb;
      color:#111827;
      border-color:#e5e7eb;
      border-left-color:#9ca3af;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- Acciones -->
    <div class="toolbar">
      <button class="btn" id="csvBtn">Exportar CSV</button>
      <button class="btn btn-primary" id="printBtn">Imprimir / Guardar PDF</button>
    </div>

    <!-- Encabezado -->
    <div class="header">
      <div class="brand">
        <!-- Solo tu logo GarBa -->
        <img src="./logo-garba.png" alt="Christian GarBa">
      </div>
      <div>
        <div class="title">Christian GarBa</div>
        <div class="sub">Seguros con Estrategia</div>
      </div>
      <div class="meta">
        <span>üìû 662 417 6032</span>
        <span>‚úâÔ∏è christian.garcia@sfgarba.com.mx</span>
      </div>
    </div>

    <!-- Banner -->
    <div class="banner">
      <strong>¬øAFORE (Ley ‚Äò97 en adelante)?</strong> Tu AFORE no ser√° suficiente <em>(y lo sabes)</em>. Empezar <u>hoy</u> tu ahorro adicional marca la diferencia: cuanto antes inicies, <strong>menos tendr√°s que aportar</strong> para lograr el mismo ingreso y m√°s tranquilidad al llegar a los 65.
    </div>

    <!-- Panel A -->
    <div class="card">
      <h2>Panel A ¬∑ Ahorro hasta los 65</h2>
      <div class="help">La edad de retiro considerada es <strong>65 a√±os</strong>. Si tu plan termina antes, el fondo sigue invirti√©ndose hasta esa edad.</div>
      <div class="grid">
        <div class="group">
          <label for="nombreOpt">Tu nombre (opcional)</label>
          <input id="nombreOpt" type="text" placeholder="Ej. Fernanda">
        </div>
        <div class="group">
          <label for="edadTop">Edad actual (a√±os)</label>
          <input id="edadTop" type="number" min="18" max="100" value="29">
        </div>
        <div class="group">
          <label for="planTop">A√±os de plan</label>
          <select id="planTop">
            <option value="15">15 a√±os</option>
            <option value="20">20 a√±os</option>
            <option value="25" selected>25 a√±os</option>
          </select>
        </div>
        <div class="group" style="grid-column:1/-1">
          <label for="metaHoy">¬øCu√°nto te gustar√≠a recibir al mes en tu retiro? (MXN, valor de hoy)</label>
          <input id="metaHoy" type="number" min="0" step="1000" placeholder="Ej. 32,000" value="32000">
          <div class="muted">Usamos este dato para sugerirte un ahorro mensual inicial realista. Tu aportaci√≥n se actualiza cada a√±o ‚âà inflaci√≥n.</div>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="planBtn">Calcular mi plan personalizado</button>
        <button class="btn" id="resetTop">Reiniciar datos</button>
      </div>

      <div class="suggest" id="sugBox">
        <div id="sugText"></div>
        <div class="muted" id="sugSup"></div>
      </div>
    </div>

    <!-- Fase 1 -->
    <div class="card">
      <h2>Fase 1 ‚Ä¢ Ahorro con inter√©s compuesto</h2>
      <p class="help">Las aportaciones se actualizan autom√°ticamente cada a√±o con la inflaci√≥n promedio que definas.</p>
      <div class="error" id="errorMsg"></div>
      <div class="grid">
        <div class="group">
          <label for="edad">Edad actual (a√±os)</label>
          <input id="edad" type="number" value="29" min="18" max="100">
        </div>
        <div class="group">
          <label for="years">A√±os que aportar√°</label>
          <input id="years" type="number" value="25" min="1" max="70">
        </div>
        <div class="group">
          <label for="pmt">Aportaci√≥n peri√≥dica inicial (MXN)</label>
          <input id="pmt" type="number" value="2500" min="0" step="0.01">
          <div class="muted">Se incrementa cada a√±o ‚âà inflaci√≥n.</div>
        </div>
        <div class="group">
          <label for="frequency">Frecuencia de aportaci√≥n</label>
          <select id="frequency">
            <option value="12" selected>Mensual</option>
            <option value="4">Trimestral</option>
            <option value="2">Semestral</option>
            <option value="1">Anual</option>
          </select>
        </div>
        <div class="group">
          <label for="lumpSum">Aportaci√≥n inicial (MXN)</label>
          <input id="lumpSum" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="rate">Rendimiento anual esperado (nominal, %)</label>
          <input id="rate" type="number" value="10" min="0" max="100" step="0.01">
        </div>
        <div class="group">
          <label for="inflation">Inflaci√≥n promedio anual (%)</label>
          <input id="inflation" type="number" value="4" min="0" max="100" step="0.01">
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcBtn">Calcular</button>
        <button class="btn" id="resetBtn">Limpiar</button>
      </div>
    </div>

    <!-- Resultados Fase 1 -->
    <div class="card">
      <h2>Resultados de la Fase 1</h2>
      <div class="kpis">
        <div class="kpi">
          <div class="kpi-label">Edad al finalizar aportaciones</div>
          <div class="kpi-value" id="edadFinal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Ahorro acumulado (nominal)</div>
          <div class="kpi-value" id="ahorroNominal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total aportado</div>
          <div class="kpi-value" id="totalAportado">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Rendimiento ganado</div>
          <div class="kpi-value" id="rendimiento">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Fondo a los 65 (si aplica)</div>
          <div class="kpi-value" id="fondo65">‚Äî</div>
        </div>
      </div>

      <div class="toggle" id="toggleTable">
        <span><strong>Detalles a√±o por a√±o</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="details">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Edad</th>
              <th>Aportado ese a√±o</th>
              <th>Saldo al cierre</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Fase 2 -->
    <div class="card">
      <h2>Fase 2 ‚Ä¢ Mensualidad de retiro</h2>
      <p class="help">La mensualidad se calcula en <strong>valor nominal (futuro)</strong>. Se toma como base el <strong>saldo a los 65</strong> de la Fase 1.</p>
      <div class="grid">
        <input type="hidden" id="pvRet" value="0">
        <div class="group">
          <label for="yrsRetSel">A√±os de retiro</label>
          <select id="yrsRetSel">
            <option value="15">15 a√±os</option>
            <option value="20" selected>20 a√±os</option>
            <option value="25">25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="rateRet">Rendimiento anual durante retiro (nominal, %)</label>
          <input id="rateRet" type="number" value="7" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="inflRet">Inflaci√≥n esperada (%)</label>
          <input id="inflRet" type="number" value="4" min="0" step="0.01">
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcRet">Calcular mensualidad</button>
      </div>

      <div class="kpis" id="retBox" style="display:none">
        <div class="kpi">
          <div class="kpi-label">Ingreso mensual estimado</div>
          <div class="kpi-value" id="pmtReal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Meses de retiro</div>
          <div class="kpi-value" id="nMeses">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Tasa real mensual</div>
          <div class="kpi-value" id="iRealMes">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Regla 4% (referencia anual)</div>
          <div class="kpi-value" id="rule4">‚Äî</div>
        </div>
      </div>

      <!-- Detalle mensual del retiro -->
      <div class="toggle" id="toggleTableRet">
        <span><strong>Detalle mensual del retiro</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="detailsRet">
        <table>
          <thead>
            <tr>
              <th>Mes</th>
              <th>Edad</th>
              <th>Retiro del mes</th>
              <th>Inter√©s del mes</th>
              <th>Saldo al cierre</th>
            </tr>
          </thead>
          <tbody id="tbodyRet"></tbody>
        </table>
      </div>

      <!-- Lectura estrat√©gica en pantalla -->
      <div class="strategic-block">
        <h3>Lectura estrat√©gica ¬∑ Lo que pasa si sigues posponiendo tu ahorro</h3>
        <p>
          Con los supuestos de esta proyecci√≥n, si buscas el 
          <strong>mismo fondo a la edad de retiro</strong>, esto es lo que tendr√≠a que cambiar tu 
          aportaci√≥n mensual inicial si decides empezar despu√©s:
        </p>
        <table class="strategic-table">
          <thead>
            <tr>
              <th>Inicio de tu plan</th>
              <th>Aportaci√≥n mensual</th>
              <th>Diferencia vs hoy</th>
              <th>Diferencia %</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Empiezas <strong>hoy</strong></td>
              <td id="ltBasePmt">‚Äî</td>
              <td>‚Äî</td>
              <td>‚Äî</td>
            </tr>
            <tr>
              <td>Empiezas en <strong>1 a√±o</strong></td>
              <td id="lt1Pmt">‚Äî</td>
              <td id="lt1Diff">$0</td>
              <td id="lt1Pct">0%</td>
            </tr>
            <tr>
              <td>Empiezas en <strong>3 a√±os</strong></td>
              <td id="lt3Pmt">‚Äî</td>
              <td id="lt3Diff">$0</td>
              <td id="lt3Pct">0%</td>
            </tr>
            <tr>
              <td>Empiezas en <strong>5 a√±os</strong></td>
              <td id="lt5Pmt">‚Äî</td>
              <td id="lt5Diff">$0</td>
              <td id="lt5Pct">0%</td>
            </tr>
          </tbody>
        </table>
        <p class="strategic-note" id="ltNote">
          Todos los escenarios usan el mismo objetivo de fondo, el mismo rendimiento y la misma inflaci√≥n.
          La conclusi√≥n es simple: <strong>cada a√±o que se pospone el inicio, el precio del mismo retiro aumenta.</strong>
        </p>
      </div>
    </div>

    <div class="muted">
      Proyecci√≥n educativa; no contempla impuestos, comisiones u otros costos. Resultados no garantizados.
    </div>
  </div>

  <!-- WhatsApp -->
  <a id="waBtn" class="wa" target="_blank" rel="noopener">Chatear por WhatsApp</a>

<script>
  // -------------------- Utilidades
  const $ = id => document.getElementById(id);
  const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(v)||0);
  const RET_AGE = 65;

  function linkWhatsApp(){
    const nombre = ($('nombreOpt').value||'').trim();
    const msg = [
      'Hola Christian, me interesa revisar mi plan.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos:*',
      `‚Ä¢ Edad: ${$('edad').value} a√±os`,
      `‚Ä¢ A√±os de aportaci√≥n: ${$('years').value}`,
      `‚Ä¢ Aportaci√≥n ${({'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'})[$('frequency').value]}: $${$('pmt').value}`
    ].filter(Boolean).join('\\n');
    $('waBtn').href = 'https://wa.me/526624176032?text='+encodeURIComponent(msg);
  }

  // -------------------- Sugerencia PMT inicial (peras con peras, NOMINAL a 65)
  function calcSuggestion(){
    const edad    = parseFloat($('edadTop').value);
    const planY   = parseInt($('planTop').value,10);
    const metaHoy = parseFloat($('metaHoy').value||0);        // MXN de HOY

    const infl    = parseFloat($('inflation').value)/100;     // inflaci√≥n (acumulaci√≥n)
    const rAcc    = parseFloat($('rate').value)/100;          // rendimiento acumulaci√≥n (nominal)
    const rRet    = parseFloat($('rateRet').value)/100;       // rendimiento retiro (nominal)
    const yrsRet  = parseInt($('yrsRetSel').value,10);
    const freq    = 12;

    if(!(edad>0 && planY>0 && metaHoy>0)){ 
      $('sugBox').style.display='none'; 
      return; 
    }

    const yrsTo65   = Math.max(0, RET_AGE - edad);

    // (1) Meta mensual en NOMINAL a los 65
    const metaNom65 = metaHoy * Math.pow(1+infl, yrsTo65);

    // (2) Capital nominal requerido a los 65 para pagar metaNom65 por yrsRet a√±os
    const iRet = rRet/freq, nRet = yrsRet*freq;
    const PVneed65 = Math.abs(iRet)<1e-12 ? metaNom65*nRet
                      : metaNom65 * ( (1 - Math.pow(1+iRet, -nRet)) / iRet );

    // (3) Horizonte real hasta los 65 y a√±os de aportaci√≥n
    const yrsTo65Real = yrsTo65;
    const yrsAport    = Math.min(planY, yrsTo65Real);
    const gapYears    = Math.max(0, yrsTo65Real - yrsAport);

    // (4) Factor de aportaciones que suben anual ‚âà inflaci√≥n (pago mensual dentro de cada a√±o)
    const iAcc = rAcc/freq;
    const N    = yrsAport*freq;
    let FV_pagos = 0, pmtYear = 1; // PMT inicial = 1 para factor
    for(let y=0; y<yrsAport; y++){
      if(y>0) pmtYear *= (1+infl);
      for(let m=0; m<freq; m++){
        const perRest = N - (y*freq + m);
        FV_pagos += pmtYear * Math.pow(1+iAcc, perRest);
      }
    }
    // crecimiento adicional hasta 65 si termina antes
    const growTo65    = Math.pow(1+iAcc, gapYears*freq);
    const totalFactor = FV_pagos * growTo65;

    const PMT_inicial = totalFactor>0 ? PVneed65 / totalFactor : 0;

    // UI principal
    const yrsTexto = gapYears>0 ? 
      ` Tu fondo seguir√° creciendo ${gapYears} a√±o(s) m√°s hasta los ${RET_AGE}.` : '';
    $('sugText').innerHTML =
      `üí° <strong>Proyecci√≥n personalizada:</strong> para lograr el ingreso que buscas en tu retiro, `+
      `un <strong>ahorro mensual inicial de ${money(PMT_inicial)}</strong> ser√≠a un buen punto de partida.`+
      `<br><span style="font-size:12px;color:#cfd8e3">Es una gu√≠a; puedes iniciar desde $2,500 MXN/mes. `+
      `Lo importante es empezar.${yrsTexto}</span>`;
    $('sugSup').innerText =
      `Supuestos: inflaci√≥n ${(infl*100).toFixed(1)}%, acumulaci√≥n ${(rAcc*100).toFixed(1)}% nominal, `+
      `retiro ${yrsRet} a√±os con ${(rRet*100).toFixed(1)}% nominal.`;
    $('sugBox').style.display='block';

    // Precarga Fase 1 con el PMT sugerido
    $('edad').value  = String(edad);
    $('years').value = String(planY);
    $('pmt').value   = String(PMT_inicial.toFixed(2));

    // Guardamos base para lectura estrat√©gica
    updateLecturaEstrategica(PVneed65, yrsTo65Real, planY, infl, rAcc, PMT_inicial);
  }

  // -------------------- Lectura estrat√©gica ‚Äì impacto de posponer (1, 3, 5 a√±os)
  function updateLecturaEstrategica(PVneed65, yrsTo65Real, planY, infl, rAcc, pmtBase){
    const freq = 12;
    const iAcc = rAcc/freq;

    function pmtDelay(delayYears){
      const yrsTo65Delayed = Math.max(0, yrsTo65Real - delayYears);
      if(yrsTo65Delayed <= 0) return null;

      const yrsAportD = Math.min(planY, yrsTo65Delayed);
      const gapD      = Math.max(0, yrsTo65Delayed - yrsAportD);

      const ND = yrsAportD*freq;
      let FV_pagosD = 0, pmtYearD = 1;
      for(let y=0; y<yrsAportD; y++){
        if(y>0) pmtYearD *= (1+infl);
        for(let m=0; m<freq; m++){
          const perRestD = ND - (y*freq + m);
          FV_pagosD += pmtYearD * Math.pow(1+iAcc, perRestD);
        }
      }
      const growD = Math.pow(1+iAcc, gapD*freq);
      const factorD = FV_pagosD * growD;
      if(factorD <= 0) return null;
      return PVneed65 / factorD;
    }

    const base = pmtBase || 0;
    $('ltBasePmt').textContent = base>0 ? money(base) : '‚Äî';

    function fillRow(delay, idPmt, idDiff, idPct){
      const pmt = pmtDelay(delay);
      if(pmt === null || !(base>0)){
        $(idPmt).textContent  = '‚Äî';
        $(idDiff).textContent = '‚Äî';
        $(idPct).textContent  = '‚Äî';
        return;
      }
      $(idPmt).textContent = money(pmt);
      const diff = pmt - base;
      const pct  = (pmt/base - 1)*100;
      $(idDiff).textContent = diff>=0 ? '+'+money(diff) : money(diff);
      $(idPct).textContent  = (pct>=0?'+':'') + pct.toFixed(1)+'%';
    }

    fillRow(1, 'lt1Pmt','lt1Diff','lt1Pct');
    fillRow(3, 'lt3Pmt','lt3Diff','lt3Pct');
    fillRow(5, 'lt5Pmt','lt5Diff','lt5Pct');

    $('ltNote').innerHTML =
      'Todos los escenarios usan el mismo objetivo de fondo, el mismo rendimiento y la misma inflaci√≥n.<br>'+
      'La conclusi√≥n es simple: <strong>cada a√±o que se pospone el inicio, el precio del mismo retiro aumenta.</strong>';
  }

  // -------------------- Fase 1 (acumulaci√≥n nominal con step-up por inflaci√≥n)
  function calcAccum(){
    const edad = parseFloat($('edad').value);
    const years = parseFloat($('years').value);
    const pmt0 = parseFloat($('pmt').value);
    const lump = parseFloat($('lumpSum').value);
    const rate = parseFloat($('rate').value)/100;
    const freq = parseFloat($('frequency').value);
    const infl = parseFloat($('inflation').value)/100;

    if([edad,years,pmt0,lump,rate,freq,infl].some(x=>isNaN(x))){
      const e=$('errorMsg'); 
      e.textContent='Completa todos los campos correctamente'; 
      e.style.display='block'; 
      return;
    } else { $('errorMsg').style.display='none'; }

    const N = Math.round(years*freq);
    const i = rate/freq;

    let FV_pmt = 0, total = lump, pmtYear = pmt0;
    for(let y=0;y<years;y++){
      if(y>1e-9 && y>0) pmtYear *= (1+infl);
      for(let p=0;p<freq;p++){
        const perRest = N - (y*freq + p);
        FV_pmt += pmtYear * Math.pow(1+i, perRest);
        total += pmtYear;
      }
    }
    const FV_nom_end = lump*Math.pow(1+i,N) + FV_pmt;
    const rend = FV_nom_end - total;
    const edadFin = edad + years;

    // Fondo a los 65
    let fondo65 = FV_nom_end;
    if(edadFin < RET_AGE){
      const extraYears = RET_AGE - edadFin;
      const Nextra = Math.round(extraYears*freq);
      fondo65 = FV_nom_end * Math.pow(1+i, Nextra);
    }

    // KPIs
    $('edadFinal').textContent   = String(Math.round(edadFin));
    $('ahorroNominal').textContent = money(FV_nom_end);
    $('totalAportado').textContent = money(total);
    $('rendimiento').textContent   = money(rend);
    $('fondo65').textContent       = money(fondo65);

    // Tabla Fase 1
    const tbody=$('tbody'); 
    tbody.innerHTML='';
    let saldo=lump, pmtY=pmt0, edadAct=edad;
    const totalYrs = Math.max(years, RET_AGE-edad);
    for(let yr=1; yr<=totalYrs; yr++){
      edadAct++;
      let aport=0;
      if(yr<=years){
        if(yr>1) pmtY *= (1+infl);
        aport = pmtY*freq;
        for(let k=0;k<freq;k++){ saldo = saldo*(1+i) + pmtY; }
      }else{
        for(let k=0;k<freq;k++){ saldo = saldo*(1+i); }
      }
      const tr=document.createElement('tr');
      if(yr>years) tr.style.background='rgba(11,94,215,.08)';
      tr.innerHTML=`<td>${yr}</td><td>${edadAct} a√±os</td><td>${yr>years?'‚Äî':money(aport)}</td><td>${money(saldo)}</td>`;
      tbody.appendChild(tr);
    }

    // Base para Fase 2
    $('pvRet').value = String(fondo65);
    linkWhatsApp();
  }

  // -------------------- Fase 2 (retiro desde saldo a 65, nominal) + DETALLE MENSUAL
  function calcRet(){
    const PV = parseFloat($('pvRet').value)||0;
    const yrs = parseInt($('yrsRetSel').value,10);
    const rateRet = parseFloat($('rateRet').value)/100;
    const infl = parseFloat($('inflRet').value)/100;

    if(PV<=0){ 
      alert('Primero calcula tu ahorro (Fase 1).'); 
      return; 
    }

    const iNom = rateRet/12, n = yrs*12;
    const PMT = Math.abs(iNom)<1e-9 ? PV/n : PV * ( iNom / (1 - Math.pow(1+iNom,-n)) );

    const rReal = ((1+rateRet)/(1+infl))-1, iReal = rReal/12;

    $('retBox').style.display='grid';
    $('pmtReal').textContent = money(PMT);
    $('nMeses').textContent  = `${n} meses`;
    $('iRealMes').textContent = `${(iReal*100).toFixed(3)}%`;
    $('rule4').textContent   = `${money(PV*0.04)} /a√±o ¬∑ ${money(PV*0.04/12)} /mes`;

    // ---- Detalle mensual (tabla)
    const tbodyRet = $('tbodyRet'); 
    tbodyRet.innerHTML='';
    let saldo = PV;
    for(let m=1; m<=n; m++){
      const interes = saldo * iNom;
      const saldoAntes = saldo + interes;
      const retiro = PMT; // retiro al fin de periodo
      const saldoDesp = Math.max(0, saldoAntes - retiro);

      const yearsAdd = Math.floor(m/12);
      const monthsRem = m % 12;
      const edadTxt = `${RET_AGE + yearsAdd} a√±os${monthsRem?` ${monthsRem} mes(es)`:''}`;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m}</td><td>${edadTxt}</td><td>${money(retiro)}</td><td>${money(interes)}</td><td>${money(saldoDesp)}</td>`;
      tbodyRet.appendChild(tr);

      saldo = saldoDesp;
    }
  }

  // -------------------- CSV (Fase 1) y eventos
  function exportCSV(){
    const rows=[['A√±o','Edad','Aportado ese a√±o (MXN)','Saldo al cierre (MXN)']];
    document.querySelectorAll('#tbody tr').forEach(tr=>{
      const t=[...tr.querySelectorAll('td')].map(td=>td.textContent.replace(/[^\d.,\\-a-z√± ]/gi,''));
      rows.push(t);
    });
    const blob=new Blob([rows.map(r=>r.join(',')).join('\\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); 
    const name=$('nombreOpt').value||'Proyeccion'; 
    const f=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob); 
    a.download=`${name}_corrida_${f}.csv`; 
    a.click(); 
    URL.revokeObjectURL(a.href);
  }

  // -------------------- PDF / impresi√≥n ejecutiva
  function printReport(){
    // Tomamos los datos clave
    const nombre  = ($('nombreOpt').value||'').trim();
    const edad    = $('edad').value;
    const years   = $('years').value;
    const pmt0    = $('pmt').value;
    const lump    = $('lumpSum').value;
    const freqLbl = ({'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'})[$('frequency').value] || 'Mensual';
    const rateAcc = $('rate').value;
    const inflAcc = $('inflation').value;
    const yrsRet  = $('yrsRetSel').value;
    const rateRet = $('rateRet').value;
    const inflRet = $('inflRet').value;

    const ahorroNominal = $('ahorroNominal').textContent;
    const totalAportado = $('totalAportado').textContent;
    const rendimiento   = $('rendimiento').textContent;
    const fondo65       = $('fondo65').textContent;

    const pmtRet   = $('pmtReal').textContent;
    const nMeses   = $('nMeses').textContent;
    const iRealMes = $('iRealMes').textContent;
    const rule4    = $('rule4').textContent;

    const basePmt = $('ltBasePmt').textContent;
    const p1Pmt   = $('lt1Pmt').textContent;
    const p1Diff  = $('lt1Diff').textContent;
    const p1Pct   = $('lt1Pct').textContent;
    const p3Pmt   = $('lt3Pmt').textContent;
    const p3Diff  = $('lt3Diff').textContent;
    const p3Pct   = $('lt3Pct').textContent;
    const p5Pmt   = $('lt5Pmt').textContent;
    const p5Diff  = $('lt5Diff').textContent;
    const p5Pct   = $('lt5Pct').textContent;

    const w=window.open('','_blank'); 
    if(!w) return;

    w.document.write(`<!doctype html>
<html><head><meta charset="utf-8"/>
<title>Plan de Retiro ‚Äì ${nombre||'Proyecci√≥n'}</title>
<style>
  body{
    font-family:Arial, sans-serif;
    margin:32px;
    color:#111827;
    background:#ffffff;
  }
  h1,h2,h3{margin:0 0 8px}
  h1{font-size:22px}
  h2{font-size:18px;margin-top:18px}
  .header{
    display:flex;
    align-items:center;
    gap:14px;
    padding-bottom:12px;
    border-bottom:1px solid #e5e7eb;
    margin-bottom:14px;
  }
  .header img{height:48px}
  .header-meta{font-size:12px;color:#4b5563;margin-top:4px}
  .section{margin-top:12px}
  .grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px 24px;
    font-size:13px;
  }
  .label{color:#6b7280}
  .value{font-weight:600}
  .kpi-box{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:12px;
    margin-top:8px;
    font-size:13px;
  }
  .kpi{
    border:1px solid #d1d5db;
    border-radius:8px;
    padding:10px 12px;
  }
  .kpi-title{
    font-size:11px;
    text-transform:uppercase;
    color:#6b7280;
    letter-spacing:.04em;
    margin-bottom:4px;
  }
  .kpi-val{
    font-size:14px;
    font-weight:700;
    color:#111827;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
    margin-top:6px;
  }
  th,td{
    border:1px solid #e5e7eb;
    padding:6px 8px;
    text-align:right;
  }
  th:first-child,td:first-child{text-align:left}
  th{background:#f3f4f6}
  .note{
    margin-top:6px;
    font-size:11px;
    color:#6b7280;
  }
  .footer{
    margin-top:18px;
    font-size:11px;
    color:#6b7280;
    border-top:1px solid #e5e7eb;
    padding-top:8px;
    text-align:center;
  }
  @media print{
    body{margin:16px}
  }
</style>
</head>
<body>
  <div class="header">
    <img src="${location.origin + (location.pathname.endsWith('/') ? location.pathname : location.pathname + '/')}logo-garba.png" alt="Christian GarBa">
    <div>
      <h1>Plan de Ahorro & Retiro</h1>
      <div class="header-meta">
        ${nombre ? ('Proyecci√≥n personalizada para ' + nombre + '<br>') : ''}
        Generado el ${new Date().toLocaleDateString('es-MX')}
      </div>
    </div>
  </div>

  <div class="section">
    <h2>1. Datos base de la proyecci√≥n</h2>
    <div class="grid">
      <div><span class="label">Edad actual:</span> <span class="value">${edad||'‚Äî'} a√±os</span></div>
      <div><span class="label">A√±os de aportaci√≥n:</span> <span class="value">${years||'‚Äî'} a√±os</span></div>
      <div><span class="label">Aportaci√≥n inicial:</span> <span class="value">${money(pmt0||0)} (${freqLbl})</span></div>
      <div><span class="label">Aportaci√≥n inicial √∫nica:</span> <span class="value">${money(lump||0)}</span></div>
      <div><span class="label">Rendimiento anual esperado (acumulaci√≥n):</span> <span class="value">${rateAcc||'‚Äî'} % nominal</span></div>
      <div><span class="label">Inflaci√≥n promedio usada:</span> <span class="value">${inflAcc||'‚Äî'} %</span></div>
      <div><span class="label">A√±os de retiro considerados:</span> <span class="value">${yrsRet||'‚Äî'} a√±os</span></div>
      <div><span class="label">Rendimiento anual durante retiro:</span> <span class="value">${rateRet||'‚Äî'} % nominal</span></div>
    </div>
  </div>

  <div class="section">
    <h2>2. Resultado del ahorro (Fase 1)</h2>
    <div class="kpi-box">
      <div class="kpi">
        <div class="kpi-title">Ahorro acumulado al final del plan</div>
        <div class="kpi-val">${ahorroNominal||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total aportado</div>
        <div class="kpi-val">${totalAportado||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Rendimiento ganado</div>
        <div class="kpi-val">${rendimiento||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Fondo estimado a los 65</div>
        <div class="kpi-val">${fondo65||'‚Äî'}</div>
      </div>
    </div>
    <div class="note">
      La edad objetivo de retiro utilizada es 65 a√±os. Si las aportaciones terminan antes, el fondo se mantiene invertido hasta esa edad.
    </div>
  </div>

  <div class="section">
    <h2>3. Ingreso estimado en retiro (Fase 2)</h2>
    <div class="kpi-box">
      <div class="kpi">
        <div class="kpi-title">Ingreso mensual estimado</div>
        <div class="kpi-val">${pmtRet||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Duraci√≥n del retiro</div>
        <div class="kpi-val">${nMeses||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Tasa real mensual aprox.</div>
        <div class="kpi-val">${iRealMes||'‚Äî'}</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Referencia regla 4%</div>
        <div class="kpi-val">${rule4||'‚Äî'}</div>
      </div>
    </div>
    <div class="note">
      El ingreso se expresa en valor nominal. La referencia ‚Äúregla del 4%‚Äù se incluye solo como punto de comparaci√≥n internacional.
    </div>
  </div>

  <div class="section">
    <h2>4. Lectura estrat√©gica ¬∑ Lo que pasa si sigues posponiendo tu ahorro</h2>
    <p style="font-size:13px">
      Con los supuestos de esta proyecci√≥n, si buscas el <strong>mismo fondo a la edad de retiro</strong>,
      esto es lo que tendr√≠a que cambiar tu aportaci√≥n mensual inicial si decides empezar despu√©s:
    </p>
    <table>
      <thead>
        <tr>
          <th>Inicio de tu plan</th>
          <th>Aportaci√≥n mensual</th>
          <th>Diferencia vs hoy</th>
          <th>Diferencia %</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Empiezas <strong>hoy</strong></td>
          <td>${basePmt||'‚Äî'}</td>
          <td>‚Äî</td>
          <td>‚Äî</td>
        </tr>
        <tr>
          <td>Empiezas en 1 a√±o</td>
          <td>${p1Pmt||'‚Äî'}</td>
          <td>${p1Diff||'‚Äî'}</td>
          <td>${p1Pct||'‚Äî'}</td>
        </tr>
        <tr>
          <td>Empiezas en 3 a√±os</td>
          <td>${p3Pmt||'‚Äî'}</td>
          <td>${p3Diff||'‚Äî'}</td>
          <td>${p3Pct||'‚Äî'}</td>
        </tr>
        <tr>
          <td>Empiezas en 5 a√±os</td>
          <td>${p5Pmt||'‚Äî'}</td>
          <td>${p5Diff||'‚Äî'}</td>
          <td>${p5Pct||'‚Äî'}</td>
        </tr>
      </tbody>
    </table>
    <div class="note">
      Todos los escenarios usan el mismo objetivo de fondo, el mismo rendimiento y la misma inflaci√≥n.
      La conclusi√≥n es simple: cada a√±o que se pospone el inicio, el precio del mismo retiro aumenta.
    </div>
  </div>

  <div class="footer">
    Christian GarBa ‚Äì Seguros con Estrategia ¬∑ Proyecci√≥n educativa, no constituye recomendaci√≥n individual ni rendimiento garantizado.
  </div>
</body>
</html>`);
    w.document.close();
  }

  // -------------------- Eventos
  $('planBtn').addEventListener('click', ()=>{ calcSuggestion(); calcAccum(); });
  $('resetTop').addEventListener('click', ()=>{
    $('nombreOpt').value='';
    $('edadTop').value=29;
    $('planTop').value='25';
    $('metaHoy').value=32000;
    $('sugBox').style.display='none';
  });

  $('calcBtn').addEventListener('click', calcAccum);
  $('resetBtn').addEventListener('click', ()=>{
    $('edad').value=29; 
    $('years').value=25; 
    $('pmt').value=2500; 
    $('frequency').value=12; 
    $('lumpSum').value=0;
    $('rate').value=10; 
    $('inflation').value=4; 
    calcAccum();
  });

  $('calcRet').addEventListener('click', calcRet);
  $('csvBtn').addEventListener('click', exportCSV);
  $('printBtn').addEventListener('click', printReport);

  $('toggleTable').addEventListener('click',()=>{
    const d=$('details'); 
    d.style.display=d.style.display==='block'?'none':'block';
  });
  $('toggleTableRet').addEventListener('click',()=>{
    const d=$('detailsRet'); 
    d.style.display=d.style.display==='block'?'none':'block';
  });

  // recalcula cuando cambian supuestos relevantes de Panel A
  ['edadTop','planTop','metaHoy','rate','inflation','rateRet','yrsRetSel'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcSuggestion(); });
  });
  // recalcula acumulaci√≥n cuando cambian inputs base
  ['edad','years','pmt','frequency','lumpSum','rate','inflation'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcAccum(); });
  });

  // init
  window.addEventListener('load', ()=>{ 
    calcSuggestion(); 
    calcAccum(); 
    linkWhatsApp(); 
  });
</script>
</body>
</html>
