<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  :root{
    --brand:#0B5ED7; --brand-2:#084cc3;
    --ink:#0f172a; --ink-2:#334155; --muted:#94a3b8;
    --paper:#ffffff; --stroke:#e5e7eb; --wa:#25D366;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#0b1223,#121a2f);color:#e5e7eb}
  a{text-decoration:none;color:inherit}
  .container{max-width:1040px;margin:0 auto;padding:24px}

  /* Header */
  .header{background:var(--paper);color:var(--ink);border:1px solid var(--stroke);border-radius:16px;padding:18px 20px;display:flex;align-items:center;gap:16px;box-shadow:0 8px 24px rgba(15,23,42,.16)}
  .brand img{height:56px;width:auto;display:block}
  .brand-title{font-weight:800;font-size:22px;line-height:1.1;color:var(--ink)}
  .brand-sub{font-size:13px;color:#64748b}
  .head-meta{margin-left:auto;text-align:right;font-size:14px;color:#475569}

  /* Acciones */
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin:14px 0 18px}
  .btn{appearance:none;border:1px solid var(--stroke);background:#fff;color:#0f172a;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,.10)}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-2)}

  /* Banner */
  .banner{background:#fff7ed;color:#7c2d12;border:1px solid #fed7aa;border-left:6px solid #fb923c;border-radius:14px;padding:14px 16px;margin:18px 0;box-shadow:0 4px 14px rgba(2,6,23,.12)}
  .banner strong{color:#9a3412}

  /* Cards */
  .card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:22px;margin:16px 0}
  .card h2{margin:0 0 10px;color:#dbe3f3;font-size:20px;font-weight:800}
  .sub{margin:2px 0 14px;color:#cbd5e1;font-size:13px}
  .muted{font-size:12px;color:var(--muted);margin-top:6px}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .group{display:flex;flex-direction:column}
  label{font-size:12px;color:#cbd5e1;margin-bottom:6px;font-weight:600}
  input,select{padding:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:#fff;border-radius:10px;font-size:16px;transition:border .15s, box-shadow .15s}
  input:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(11,94,215,.25)}

  /* Tarjeta profesional inicial */
  .card-white{background:#ffffff;color:#0f172a;border:1px solid var(--stroke);border-radius:16px;padding:20px;box-shadow:0 8px 20px rgba(2,6,23,.08)}
  .card-white label{color:#0f172a}
  .card-white input,.card-white select{background:#f8fafc;border:1px solid #e2e8f0;color:#0f172a}
  .card-white .muted{color:#64748b}

  .suggest{border:1px solid rgba(11,94,215,.35);background:linear-gradient(0deg,rgba(11,94,215,.09),rgba(11,94,215,.09));border-left:6px solid var(--brand);border-radius:14px;padding:14px;margin-top:12px}
  .suggest strong{color:#eaf2ff}

  /* KPIs */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:6px}
  .kpi{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:16px}
  .kpi-label{font-size:11px;letter-spacing:.4px;color:#a9b4c7;text-transform:uppercase}
  .kpi-value{font-size:22px;font-weight:800;color:#f8fafc;transform:translateY(4px);opacity:.0;transition:opacity .35s ease, transform .35s ease}

  .details-toggle{display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,.12);padding:12px 14px;border-radius:12px;margin-top:10px}
  .details{display:none;overflow:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th{background:rgba(255,255,255,.08);text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.14);font-size:13px}
  td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}

  /* WhatsApp */
  .wa{position:fixed;right:18px;bottom:22px;background:var(--wa);color:#06371a;border-radius:999px;padding:12px 16px;font-weight:800;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:999}

  /* Portada impresi√≥n */
  .print-cover{display:none}
  @media print{
    body{background:#fff;color:#000}
    .wa,.toolbar,.details-toggle{display:none!important}
    .print-cover{display:block;page-break-after:always;padding:40px}
    .cover{border:2px solid var(--brand);border-radius:18px;padding:26px}
    .cover-head{display:flex;align-items:center;gap:16px;margin-bottom:16px}
    .cover-head img{height:70px;width:auto;border:1px solid var(--brand);border-radius:8px;padding:6px;background:#fff}
    .cover-title{font-size:26px;font-weight:800;color:#0B5ED7}
    .cover-row{display:flex;gap:18px}
    .cover-col{flex:1;border:1px dashed #cbd5e1;border-radius:12px;padding:12px}
    .cover-label{font-size:12px;color:#64748b;text-transform:uppercase}
    .cover-value{font-size:18px;font-weight:700}
    .cover-qr{display:flex;align-items:center;gap:14px;margin-top:14px}
    .kpi{background:#f1f5f9;border-color:#e2e8f0;color:#0f172a}
    .kpi-value{color:#0f172a}
  }
</style>
</head>
<body>
  <div class="container">

    <!-- Acciones -->
    <div class="toolbar">
      <button class="btn" id="csvBtn">Exportar CSV</button>
      <button class="btn btn-primary" id="printBtn">Imprimir / Guardar PDF</button>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="brand"><img src="./logo-garba.png" alt="Christian GarBa"/></div>
      <div>
        <div class="brand-title">Christian GarBa</div>
        <div class="brand-sub">Seguros con Estrategia</div>
      </div>
      <div class="head-meta">
        <div>üìû 662 417 6032</div>
        <div>‚úâÔ∏è christian.garcia@sfgarba.com.mx</div>
      </div>
    </div>

    <!-- Banner -->
    <div class="banner">
      <strong>¬øAFORE (Ley ‚Äò97 en adelante)?</strong> Tu AFORE no ser√° suficiente <em>(y lo sabes)</em>. Empezar <u>hoy</u> tu ahorro adicional marca la diferencia: cuanto antes inicies, <strong>menos tendr√°s que aportar</strong> para lograr el mismo ingreso y m√°s tranquilidad al llegar a los 65.
    </div>

    <!-- NUEVO BLOQUE SUPERIOR (profesional, sin romper nada m√°s) -->
    <div class="card-white" id="topCard">
      <h2>Tu punto de partida</h2>
      <div class="grid">
        <div class="group">
          <label for="nombreTop">Tu nombre (opcional)</label>
          <input id="nombreTop" type="text" placeholder="Ej. Fernanda"/>
        </div>
        <div class="group">
          <label for="edadTop">Edad actual (a√±os)</label>
          <input id="edadTop" type="number" value="35" min="18" max="100"/>
        </div>
        <div class="group">
          <label for="planTop">A√±os de plan</label>
          <select id="planTop">
            <option value="15">15 a√±os</option>
            <option value="20">20 a√±os</option>
            <option value="25" selected>25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="metaTop">¬øCu√°nto te gustar√≠a recibir al mes en tu retiro? (MXN, valor de hoy)</label>
          <input id="metaTop" type="number" min="0" step="0.01" placeholder="Ej. 30,000"/>
          <div class="muted">Usamos este dato para sugerirte un ahorro mensual inicial realista.</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn btn-primary" id="calcTop">Calcular mi plan personalizado</button>
        <button class="btn" id="limpiarTop">Reiniciar datos</button>
      </div>

      <div class="suggest" id="sugerenciaBox" style="display:none">
        <div style="margin-bottom:6px">Para lograr el ingreso que buscas en tu retiro, este ser√≠a el <strong>ahorro mensual inicial recomendado:</strong> <strong><span id="sugAhorro">$0</span></strong>. <span class="muted">(Se actualizar√° cada a√±o con la inflaci√≥n.)</span></div>
        <div class="muted">üïí La edad de retiro considerada es de 65 a√±os.</div>
        <div class="muted" id="sugNota65" style="margin-top:4px;display:none"></div>
        <div class="muted" style="margin-top:6px"><strong>Puedes iniciar desde $2,500 MXN/mes</strong>; lo importante es empezar.</div>
      </div>
    </div>

    <!-- Fase 1 -->
    <div class="card">
      <h2>Fase 1 ‚Ä¢ Ahorro con inter√©s compuesto</h2>
      <p class="sub">Las aportaciones se actualizan autom√°ticamente cada a√±o con la inflaci√≥n promedio definida.</p>
      <div class="error" id="errorMsg"></div>

      <div class="grid">
        <div class="group">
          <label for="years">A√±os que aportar√°</label>
          <input id="years" type="number" value="25" min="1" max="70"/>
          <div class="muted" id="notaCap" style="display:none"></div>
        </div>
        <div class="group">
          <label for="pmt">Aportaci√≥n peri√≥dica inicial (MXN)</label>
          <input id="pmt" type="number" value="2500" min="0" step="0.01"/>
          <div class="muted">Se incrementa cada a√±o ‚âà inflaci√≥n.</div>
        </div>
        <div class="group">
          <label for="frequency">Frecuencia de aportaci√≥n</label>
          <select id="frequency">
            <option value="12" selected>Mensual</option>
            <option value="4">Trimestral</option>
            <option value="2">Semestral</option>
            <option value="1">Anual</option>
          </select>
        </div>
        <div class="group">
          <label for="lumpSum">Aportaci√≥n inicial (MXN)</label>
          <input id="lumpSum" type="number" value="0" min="0" step="0.01"/>
        </div>
        <div class="group">
          <label for="rate">Rendimiento anual esperado (nominal, %)</label>
          <input id="rate" type="number" value="10" min="0" max="100" step="0.01"/>
        </div>
        <div class="group">
          <label for="inflation">Inflaci√≥n promedio anual (%)</label>
          <input id="inflation" type="number" value="4" min="0" max="100" step="0.01"/>
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcBtn">Calcular</button>
        <button class="btn" id="resetBtn">Limpiar</button>
      </div>
    </div>

    <!-- Resultados Fase 1 -->
    <div class="card">
      <h2>Resultados de la Fase 1</h2>
      <div class="kpis">
        <div class="kpi"><div class="kpi-label">Edad al finalizar aportaciones</div><div class="kpi-value" id="edadFinal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Ahorro acumulado (nominal)</div><div class="kpi-value" id="ahorroNominal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Total aportado</div><div class="kpi-value" id="totalAportado">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Rendimiento ganado</div><div class="kpi-value" id="rendimiento">‚Äî</div></div>
        <div class="kpi" data-kpi-65 style="display:none;"><div class="kpi-label">Fondo a los 65 (si aplica)</div><div class="kpi-value" data-kpi-65-val>‚Äî</div></div>
      </div>

      <div class="details-toggle" id="toggleTable"><span><strong>Detalles a√±o por a√±o</strong></span><span>‚ñº</span></div>
      <div class="details" id="details">
        <table>
          <thead><tr><th>A√±o</th><th>Edad</th><th>Aportado ese a√±o</th><th>Saldo al cierre</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Fase 2 -->
    <div class="card">
      <h2>Fase 2 ‚Ä¢ Mensualidad de retiro</h2>
      <p class="sub">Se calcula en <strong>valor futuro (nominal)</strong> usando la tasa nominal de retiro. La base es el <strong>fondo nominal a los 65</strong>.</p>
      <div class="grid">
        <input type="hidden" id="pvRet" value="0"/>
        <div class="group">
          <label for="yrsRetSel">A√±os de retiro</label>
          <select id="yrsRetSel">
            <option value="15">15 a√±os</option>
            <option value="20" selected>20 a√±os</option>
            <option value="25">25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="rateRet">Rendimiento anual durante retiro (nominal, %)</label>
          <input id="rateRet" type="number" value="7" min="0" step="0.01"/>
        </div>
        <div class="group">
          <label for="inflRet">Inflaci√≥n esperada (%)</label>
          <input id="inflRet" type="number" value="4" min="0" step="0.01"/>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcRet">Calcular mensualidad</button>
      </div>

      <div class="kpis" id="retBox" style="display:none">
        <div class="kpi"><div class="kpi-label">Ingreso mensual estimado (nominal)</div><div class="kpi-value" id="pmtReal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Meses de retiro</div><div class="kpi-value" id="nMeses">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Tasa real mensual (referencia)</div><div class="kpi-value" id="iRealMes">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Regla 4% (referencia anual)</div><div class="kpi-value" id="rule4">‚Äî</div></div>
      </div>

      <div class="details-toggle" id="toggleRetTable"><span><strong>Detalles del retiro (resumen anual)</strong></span><span>‚ñº</span></div>
      <div class="details" id="retDetails">
        <table>
          <thead>
            <tr>
              <th>A√±o de retiro</th>
              <th>Saldo inicial</th>
              <th>Inter√©s del a√±o</th>
              <th>Retiros del a√±o</th>
              <th>Saldo final</th>
            </tr>
          </thead>
          <tbody id="retTbody"></tbody>
        </table>
        <div class="muted">*La vista es anual para facilitar lectura. Si prefieres, puedo activar la vista mensual completa.</div>
      </div>
    </div>

    <div class="muted">Proyecci√≥n educativa; no contempla impuestos, comisiones u otros costos. Resultados no garantizados.</div>
  </div>

  <!-- WhatsApp -->
  <a id="waBtn" class="wa" target="_blank" rel="noopener">Chatear por WhatsApp</a>

  <!-- Portada impresi√≥n -->
  <div class="print-cover">
    <div class="cover">
      <div class="cover-head">
        <img src="./logo-garba.png" alt="Christian GarBa"/>
        <div>
          <div class="cover-title">Proyecci√≥n de Ahorro & Retiro</div>
          <div>Christian GarBa ¬∑ Seguros con Estrategia</div>
        </div>
      </div>
      <div class="cover-row">
        <div class="cover-col"><div class="cover-label">Prospecto</div><div class="cover-value" id="cProspecto">‚Äî</div></div>
        <div class="cover-col"><div class="cover-label">Fecha</div><div class="cover-value" id="cFecha">‚Äî</div></div>
      </div>
      <div class="cover-qr">
        <img id="cQR" alt="QR WhatsApp"/>
        <div>Escan√©ame para conversar por WhatsApp<br><strong>+52 662 417 6032</strong><br>christian.garcia@sfgarba.com.mx</div>
      </div>
    </div>
  </div>

<script>
  const LS='calc_garba_v5';
  let lastAhorro=0,lastMens=0;
  const $=id=>document.getElementById(id);
  const money=v=>new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(v||0);

  function countUp(el, value, formatter = (v)=>v){
    el.style.opacity='0'; el.style.transform='translateY(4px)';
    const start=0, end=value, dur=450, st=performance.now();
    function tick(t){
      const p=Math.min(1,(t-st)/dur);
      const cur = start + (end - start)*p;
      el.textContent = formatter(cur);
      el.style.opacity='1'; el.style.transform='translateY(0)';
      if(p<1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  /* Sin tocar tu l√≥gica base: s√≥lo sincronizo la cabecera con los campos existentes */
  function syncFromTop(){
    const edad=parseFloat($('edadTop').value)||35;
    const plan=parseInt($('planTop').value,10)||25;
    $('edad').value = edad;           // muestra la edad tambi√©n en Fase 1 si la usas internamente
    $('years').value = plan;          // ‚ÄúA√±os que aportar√°‚Äù se alinea al plan elegido
  }

  function save(){
    const ids=['nombreTop','edadTop','planTop','metaTop','edad','years','pmt','frequency','lumpSum','rate','inflation','yrsRetSel','rateRet','inflRet'];
    const d={}; ids.forEach(i=>d[i]=$(i).value); localStorage.setItem(LS,JSON.stringify(d));
  }
  function load(){
    try{const d=JSON.parse(localStorage.getItem(LS)||'{}');Object.keys(d).forEach(k=>$(k)&&($(k).value=d[k]));}catch(e){}
  }

  function updateWA(){
    const nombre=($('nombreTop').value||'').trim();
    const msg=[
      'Hola Christian, me interesa revisar mi plan.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos:*',
      `‚Ä¢ Edad: ${$('edadTop').value} a√±os`,
      `‚Ä¢ Plan elegido: ${$('planTop').value} a√±os`,
      $('metaTop').value?`‚Ä¢ Meta mensual en retiro (valor de hoy): $${$('metaTop').value}`:'',
      `‚Ä¢ Aportaci√≥n ${({'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'})[$('frequency').value]} estimada: $${$('pmt').value}`,
      lastAhorro?`‚Ä¢ Fondo base a los 65: ${money(lastAhorro)}`:'',
      lastMens?`‚Ä¢ Ingreso mensual estimado: ${money(lastMens)}`:''
    ].filter(Boolean).join('\n');
    $('waBtn').href='https://wa.me/526624176032?text='+encodeURIComponent(msg);
  }

  /* Sugerencia: usa edad, plan y meta ‚Äúvalor de hoy‚Äù; fin de aportes a los 65 por regla */
  function calcSuggest(){
    const ingresoHoy=parseFloat($('metaTop').value);
    const edad=parseFloat($('edadTop').value);
    const plan=parseInt($('planTop').value,10);
    const rate=parseFloat($('rate').value)/100;          // 10% nominal por defecto
    const infl=parseFloat($('inflation').value)/100;     // 4% por defecto
    const rateRet=parseFloat($('rateRet').value)/100;    // 7% por defecto
    const yrsRet=parseInt($('yrsRetSel').value,10);      // 20 por defecto

    if(!ingresoHoy || isNaN(edad) || isNaN(plan)){ $('sugerenciaBox').style.display='none'; return; }

    // A√±os efectivos de aportaci√≥n (no se aportar√° m√°s all√° de 65)
    const yearsEff = Math.max(0, Math.min(plan, Math.max(0, 65 - edad)));
    const yearsExtra = Math.max(0, 65 - (edad + yearsEff)); // crecimiento sin aportes
    const sugNote = $('sugNota65');

    if (yearsEff < plan) {
      sugNote.style.display='block';
      sugNote.textContent = `Aportar√°s ${yearsEff} a√±os y tu fondo crecer√° ${yearsExtra} m√°s hasta los 65.`;
    } else if (yearsExtra > 0) {
      sugNote.style.display='block';
      sugNote.textContent = `Tu fondo crecer√° ${yearsExtra} a√±os m√°s hasta los 65.`;
    } else {
      sugNote.style.display='none';
    }

    // C√°lculo en t√©rminos REALES (peras con peras)
    const rAcc=((1+rate)/(1+infl))-1;         // ~5.769% real
    const iAcc=rAcc/12;
    const rRet=((1+rateRet)/(1+infl))-1;      // ~2.885% real
    const iRet=rRet/12;

    // PV necesario a los 65 para pagar ingresoHoy real durante yrsRet a√±os
    const nRet=yrsRet*12;
    const PV65 = Math.abs(iRet)<1e-12 ? ingresoHoy*nRet : ingresoHoy*((1-Math.pow(1+iRet,-nRet))/iRet);

    // Factor de acumulaci√≥n: aportas yearsEff a√±os y capitaliza yearsExtra sin aportar
    const N=yearsEff*12, K=yearsExtra*12;
    const factorAportes = Math.abs(iAcc)<1e-12 ? N : (Math.pow(1+iAcc,N)-1)/iAcc;
    const F = (N>0 ? factorAportes : 0) * Math.pow(1+iAcc, K);

    const pmtSugerida = (F>0) ? (PV65/F) : 0;

    $('sugerenciaBox').style.display='block';
    $('sugAhorro').textContent = money(pmtSugerida);
  }

  /* === TU L√ìGICA DE FASE 1 SE CONSERVA === */
  function calcAccum(){
    const edad = parseFloat($('edadTop').value);
    const yearsInput = parseFloat($('years').value);
    const pmt = parseFloat($('pmt').value);
    const lump = parseFloat($('lumpSum').value);
    const rate = parseFloat($('rate').value) / 100;       // nominal anual
    const freq = parseInt($('frequency').value, 10);      // 12/4/2/1
    const infl = parseFloat($('inflation').value) / 100;  // inflaci√≥n anual

    if ([edad, yearsInput, pmt, lump, rate, infl].some(x => isNaN(x)) || !freq) {
      const e = $('errorMsg'); e.textContent = 'Completa todos los campos correctamente'; e.classList.add('show'); return;
    } else { $('errorMsg').classList.remove('show'); }

    // Regla: fin de aportaciones a los 65
    const yearsEff = Math.max(0, Math.min(yearsInput, Math.max(0, 65 - edad)));
    const nota = $('notaCap');
    if (yearsEff < yearsInput) { nota.style.display='block'; nota.textContent=`Se consideraron ${yearsEff} a√±os efectivos de aportaci√≥n (hasta los 65).`; }
    else { nota.style.display='none'; }

    const N = yearsEff * freq;
    const i = rate / freq;

    // FV lump
    const FV_lump = N>0 ? lump * Math.pow(1 + i, N) : lump;

    // FV aportes con crecimiento anual por inflaci√≥n (pago uniforme dentro del a√±o)
    let FV_pmt = 0, totalAport = lump, pmtYear = pmt;
    for (let y = 0; y < yearsEff; y++) {
      if (y > 0) pmtYear *= (1 + infl);
      for (let p = 0; p < freq; p++) {
        const perRest = N - (y * freq + p);
        FV_pmt += pmtYear * Math.pow(1 + i, perRest);
        totalAport += pmtYear;
      }
    }

    let saldo = FV_lump + FV_pmt;   // saldo al terminar aportaciones
    const edadFin = edad + yearsEff;
    const rendimiento = saldo - totalAport;

    countUp($('edadFinal'), Math.round(edadFin), v => String(Math.round(v)));
    countUp($('ahorroNominal'), saldo, money);
    countUp($('totalAportado'), totalAport, money);
    countUp($('rendimiento'), rendimiento, money);

    // Tabla y extensi√≥n hasta 65 (solo capitaliza)
    const tbody=$('tbody'); tbody.innerHTML='';
    let tablaSaldo = lump, pmtY = pmt, edadAct = edad;

    for (let yr = 1; yr <= yearsEff; yr++) {
      edadAct++;
      if (yr > 1) pmtY *= (1 + infl);
      const aportAno = pmtY * freq;
      for (let k = 0; k < freq; k++) { tablaSaldo = tablaSaldo * (1 + i) + pmtY; }
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${yr}</td><td>${edadAct} a√±os</td><td>${money(aportAno)}</td><td>${money(tablaSaldo)}</td>`;
      tbody.appendChild(tr);
    }

    if (edadFin < 65) {
      const yearsExtra = 65 - edadFin;
      for (let yr = 1; yr <= yearsExtra; yr++) {
        edadAct++;
        for (let k = 0; k < freq; k++) { tablaSaldo = tablaSaldo * (1 + i); }
        const tr=document.createElement('tr');
        tr.style.background='rgba(11,94,215,0.08)';
        tr.innerHTML = `<td>${yearsEff + yr}</td><td>${edadAct} a√±os</td><td>‚Äî</td><td>${money(tablaSaldo)}</td>`;
        tbody.appendChild(tr);
      }
      saldo = tablaSaldo;
      document.querySelector('[data-kpi-65]').style.display='block';
      document.querySelector('[data-kpi-65-val]').textContent = money(saldo);
    } else {
      const box=document.querySelector('[data-kpi-65]'); if (box) box.style.display='none';
    }

    $('pvRet').value = Math.max(0, Math.round(saldo));
    lastAhorro = saldo;

    updateWA(); calcSuggest(); save();
    document.querySelectorAll('.kpi-value').forEach(el=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; });
  }

  /* === FASE 2: igual que ya ten√≠as, partiendo del fondo a los 65 === */
  function calcRet(){
    const PV = parseFloat($('pvRet').value) || 0;
    const yrs = parseInt($('yrsRetSel').value, 10);
    const rateRet = parseFloat($('rateRet').value) / 100;
    const infl = parseFloat($('inflRet').value) / 100;

    if (PV <= 0) { alert('Primero calcula tu ahorro (Fase 1).'); return; }

    const i = rateRet / 12;     // nominal mensual
    const n = yrs * 12;

    let PMT;
    if (Math.abs(i) < 1e-12) PMT = PV / n;
    else PMT = PV * ( i / (1 - Math.pow(1 + i, -n)) );

    $('retBox').style.display='grid';
    countUp($('pmtReal'), PMT, money);
    countUp($('nMeses'), n, v => `${Math.round(v)} meses`);

    const rReal = ((1 + rateRet) / (1 + infl)) - 1; // referencia
    countUp($('iRealMes'), (rReal/12)*100, v => `${v.toFixed(3)}%`);

    const anual = PV * 0.04, mensual = anual/12;
    $('rule4').textContent = `${money(anual)} /a√±o ¬∑ ${money(mensual)} /mes`;

    // Tabla retiro (anual, saldo sigue generando rendimiento)
    const retTbody = $('retTbody'); retTbody.innerHTML='';
    const g = Math.pow(1 + i, 12);
    const factor = (Math.abs(i) < 1e-12) ? 12 : (g - 1) / i; // suma geom√©trica 12 pagos
    const retiroAnual = PMT * 12;

    let saldoIni = PV;
    for (let y = 1; y <= yrs; y++) {
      const saldoFin = (Math.abs(i) < 1e-12) ? (saldoIni - retiroAnual) : (saldoIni * g - PMT * factor);
      const interesAnual = saldoFin - (saldoIni - retiroAnual);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${y}</td>
        <td>${money(saldoIni)}</td>
        <td>${money(interesAnual)}</td>
        <td>${money(retiroAnual)}</td>
        <td>${money(Math.max(0, saldoFin))}</td>
      `;
      retTbody.appendChild(tr);

      saldoIni = Math.max(0, saldoFin);
    }
    $('retDetails').style.display='block';

    lastMens = PMT; updateWA(); save();
  }

  function exportCSV(){
    const rows=[['A√±o','Edad','Aportado ese a√±o (MXN)','Saldo al cierre (MXN)']];
    document.querySelectorAll('#tbody tr').forEach(tr=>{
      const t=[...tr.querySelectorAll('td')].map(td=>td.textContent.replace(/[^\d.,\-a-z√± ]/gi,''));
      rows.push(t);
    });
    const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); const name=$('nombreTop').value||'Proyeccion', f=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob); a.download=`${name}_corrida_${f}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  function setupCover(){
    $('cProspecto').textContent=($('nombreTop').value||'‚Äî').trim()||'‚Äî';
    $('cFecha').textContent=new Date().toLocaleDateString('es-MX',{year:'numeric',month:'long',day:'numeric'});
    const url='https://wa.me/526624176032?text='+encodeURIComponent('Hola Christian, me interesa revisar mi plan.');
    $('cQR').src='https://api.qrserver.com/v1/create-qr-code/?size=220x220&data='+encodeURIComponent(url);
  }

  // Eventos
  $('calcTop').addEventListener('click',()=>{ syncFromTop(); calcSuggest(); calcAccum(); });
  $('limpiarTop').addEventListener('click',()=>{
    ['nombreTop','metaTop'].forEach(k=>$(k).value='');
    $('edadTop').value=35; $('planTop').value='25';
    $('sugerenciaBox').style.display='none';
    syncFromTop(); calcSuggest(); calcAccum();
  });

  $('calcBtn').addEventListener('click',calcAccum);
  $('calcRet').addEventListener('click',calcRet);
  $('csvBtn').addEventListener('click',exportCSV);
  $('printBtn').addEventListener('click',()=>{ setupCover(); window.print(); });
  $('resetBtn').addEventListener('click',()=>{
    localStorage.removeItem(LS);
    ['nombreTop','metaTop'].forEach(k=>$(k).value='');
    $('edadTop').value=35; $('planTop').value='25';
    $('edad').value=35;$('years').value=25;$('pmt').value=2500;$('frequency').value=12;$('lumpSum').value=0;$('rate').value=10;$('inflation').value=4;
    $('yrsRetSel').value='20';$('rateRet').value=7;$('inflRet').value=4;
    $('sugerenciaBox').style.display='none'; $('retDetails').style.display='none';
    calcSuggest(); calcAccum();
  });

  // Recalcular en vivo
  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input',()=>{ save(); updateWA(); }));
  ['edadTop','planTop','metaTop','rate','inflation','yrsRetSel','rateRet','inflRet'].forEach(id=>{
    $(id).addEventListener('input', ()=>{ if(id!=='metaTop'){ syncFromTop(); } calcSuggest(); });
  });

  $('toggleTable').addEventListener('click',()=>{ const d=$('details'); d.style.display=d.style.display==='block'?'none':'block'; });
  $('toggleRetTable').addEventListener('click',()=>{ const d=$('retDetails'); d.style.display=d.style.display==='block'?'none':'block'; });

  // Init
  window.addEventListener('load',()=>{ load(); syncFromTop(); calcSuggest(); calcAccum(); updateWA(); setupCover(); });
</script>
</body>
</html>
