<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#0B5ED7; --brand-2:#084cc3;
    --ink:#0f172a; --muted:#94a3b8;
    --paper:#111827; --panel:#0b1324; --line:rgba(255,255,255,.14);
    --pill:#0c1e3f; --pill-border:#2557b7;
    --wa:#25D366;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:linear-gradient(135deg,#0b1223,#121a2f);color:#e5e7eb}
  a{color:inherit;text-decoration:none}
  .container{max-width:1040px;margin:0 auto;padding:22px}

  /* Header */
  .header{background:#ffffff;border:1px solid #e5e7eb;border-radius:16px;padding:16px 18px;display:flex;align-items:center;gap:14px;box-shadow:0 8px 24px rgba(15,23,42,.16)}
  .brand img{height:56px;width:auto;display:block}
  .title{font-weight:800;font-size:22px;color:#0f172a}
  .sub{font-size:13px;color:#475569}
  .meta{margin-left:auto;text-align:right;font-size:14px;color:#111827; display:flex; gap:24px}
  .meta span{display:flex;gap:8px;align-items:center}

  /* Toolbar */
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin:14px 0 18px}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:#0f172a;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:.2s}
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,.10)}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-2)}

  /* Banner */
  .banner{background:#fff7ed;color:#7c2d12;border:1px solid #fed7aa;border-left:6px solid #fb923c;border-radius:14px;padding:14px 16px;margin:18px 0;box-shadow:0 4px 14px rgba(2,6,23,.12)}
  .banner strong{color:#9a3412}

  /* Cards */
  .card{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:16px;padding:22px;margin:16px 0}
  .card h2{margin:0 0 10px;color:#dbe3f3;font-size:20px;font-weight:800}
  .help{margin:-2px 0 14px;color:#cbd5e1;font-size:13px}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .group{display:flex;flex-direction:column}
  label{font-size:12px;color:#cbd5e1;margin-bottom:6px;font-weight:600}
  input,select{padding:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:#fff;border-radius:10px;font-size:16px;transition:border .15s, box-shadow .15s}
  input:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(11,94,215,.25)}
  .muted{font-size:12px;color:#94a3b8;margin-top:6px}

  /* Suggestion (alto contraste) */
  .suggest{display:none;border:1px solid var(--pill-border);background:linear-gradient(0deg,rgba(11,94,215,.12),rgba(11,94,215,.12));border-left:6px solid var(--brand);border-radius:14px;padding:14px;margin-top:12px}
  .suggest strong{color:#eaf2ff}

  /* Lectura estrat√©gica */
  .insight{display:none;margin-top:10px;border:1px dashed rgba(255,255,255,.25);border-radius:12px;padding:12px;background:rgba(255,255,255,.04);color:#dbeafe}
  .insight h3{margin:0 0 6px;font-size:13px;color:#93c5fd}
  .insight ul{margin:0 0 0 18px;padding:0}
  .insight li{margin:4px 0}

  /* KPIs */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:6px}
  .kpi{background:rgba(255,255,255,.06);border:1px solid var(--line);border-radius:14px;padding:16px}
  .kpi-label{font-size:11px;letter-spacing:.4px;color:#a9b4c7;text-transform:uppercase}
  .kpi-value{font-size:22px;font-weight:800;color:#f8fafc}

  /* Details table */
  .toggle{display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:1px solid var(--line);padding:12px 14px;border-radius:12px;margin-top:10px}
  .details{display:none;overflow:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th{background:rgba(255,255,255,.08);text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,.14);font-size:13px}
  td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}

  /* WhatsApp */
  .wa{position:fixed;right:18px;bottom:22px;background:var(--wa);color:#06371a;border-radius:999px;padding:12px 16px;font-weight:800;box-shadow:0 10px 24px rgba(0,0,0,.25)}

  .error{display:none;background:rgba(220,53,69,.18);border:1px solid rgba(220,53,69,.4);color:#fecaca;padding:10px;border-radius:10px;margin:8px 0}
  .error.show{display:block}

  /* Print (oculta elementos web y define pie PDF) */
  @media print{
    .wa,.toolbar,.toggle{display:none!important}
    body{background:#fff;color:#000}
    .print-footer {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10.5px;
      color: #64748B;
      border-top: 1px solid #CBD5E1;
      padding-top: 6px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .print-footer img { height: 22px; width: auto; opacity: .9; }
    .print-footer .print-date { display:block; font-size:9.5px; color:#94A3B8; margin-top:2px; }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- Acciones -->
    <div class="toolbar">
      <button class="btn" id="csvBtn">Exportar CSV</button>
      <button class="btn btn-primary" id="printBtn">Imprimir / Guardar PDF</button>
    </div>

    <!-- Encabezado -->
    <div class="header">
      <div class="brand"><img src="./logo-garba.png" alt="Christian GarBa"></div>
      <div>
        <div class="title">Christian GarBa</div>
        <div class="sub">Seguros con Estrategia</div>
      </div>
      <div class="meta">
        <span>üìû 662 417 6032</span>
        <span>‚úâÔ∏è christian.garcia@sfgarba.com.mx</span>
      </div>
    </div>

    <!-- Banner -->
    <div class="banner">
      <strong>¬øAFORE (Ley ‚Äò97 en adelante)?</strong> Tu AFORE no ser√° suficiente <em>(y lo sabes)</em>. Empezar <u>hoy</u> tu ahorro adicional marca la diferencia: cuanto antes inicies, <strong>menos tendr√°s que aportar</strong> para lograr el mismo ingreso y m√°s tranquilidad al llegar a los 65.
    </div>

    <!-- Panel A ¬∑ Ahorro hasta los 65 -->
    <div class="card">
      <h2>Panel A ¬∑ Ahorro hasta los 65</h2>
      <div class="help">La edad de retiro considerada es <strong>65 a√±os</strong>. Si tu plan termina antes, el fondo sigue invirti√©ndose hasta esa edad.</div>

      <!-- Datos de partida -->
      <div class="grid">
        <div class="group">
          <label for="nombreOpt">Tu nombre (opcional)</label>
          <input id="nombreOpt" type="text" placeholder="Ej. Fernanda">
        </div>
        <div class="group">
          <label for="edadTop">Edad actual (a√±os)</label>
          <input id="edadTop" type="number" min="18" max="100" value="29">
        </div>
        <div class="group">
          <label for="planTop">A√±os de plan</label>
          <select id="planTop">
            <option value="15">15 a√±os</option>
            <option value="20">20 a√±os</option>
            <option value="25" selected>25 a√±os</option>
          </select>
        </div>
        <div class="group" style="grid-column:1/-1">
          <label for="metaHoy">¬øCu√°nto te gustar√≠a recibir al mes en tu retiro? (MXN, valor de hoy)</label>
          <input id="metaHoy" type="number" min="0" step="1000" placeholder="Ej. 32,000" value="32000">
          <div class="muted">Usamos este dato para sugerirte un ahorro mensual inicial realista (tu aporte crece cada a√±o ‚âà inflaci√≥n).</div>
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="planBtn">Calcular mi plan personalizado</button>
        <button class="btn" id="resetTop">Reiniciar datos</button>
      </div>

      <!-- Sugerencia -->
      <div class="suggest" id="sugBox">
        <div id="sugText"></div>
        <div class="muted" id="sugSup"></div>
      </div>

      <!-- Lectura estrat√©gica -->
      <div class="insight" id="insightBox">
        <h3>üß≠ Lectura estrat√©gica</h3>
        <ul>
          <li>A los 31 a√±os, cada peso que no se aporta hoy pierde ~15 a√±os de rendimiento compuesto antes del retiro.</li>
          <li>La aportaci√≥n requerida ya supera los $4,800, casi el doble de quien empez√≥ a los 25.</li>
          <li><strong>‚ÄúA los 25 pod√≠as alcanzar tu retiro con $2,600 al mes. A los 31 ya necesitas casi el doble. El tiempo no solo pasa, tambi√©n se capitaliza.‚Äù</strong></li>
        </ul>
      </div>
    </div>

    <!-- Par√°metros y c√°lculo Ahorro -->
    <div class="card">
      <h2>Par√°metros de acumulaci√≥n</h2>
      <p class="help">Las aportaciones se actualizan autom√°ticamente cada a√±o con la inflaci√≥n promedio que definas.</p>
      <div class="error" id="errorMsg"></div>
      <div class="grid">
        <div class="group">
          <label for="edad">Edad actual (a√±os)</label>
          <input id="edad" type="number" value="29" min="18" max="100">
        </div>
        <div class="group">
          <label for="years">A√±os que aportar√°</label>
          <input id="years" type="number" value="25" min="1" max="70">
        </div>
        <div class="group">
          <label for="pmt">Aportaci√≥n mensual inicial (MXN)</label>
          <input id="pmt" type="number" value="2500" min="0" step="0.01">
          <div class="muted">Se incrementa cada a√±o ‚âà inflaci√≥n.</div>
        </div>
        <div class="group">
          <label for="frequency">Frecuencia de aportaci√≥n</label>
          <select id="frequency">
            <option value="12" selected>Mensual</option>
            <option value="4">Trimestral</option>
            <option value="2">Semestral</option>
            <option value="1">Anual</option>
          </select>
        </div>
        <div class="group">
          <label for="lumpSum">Aportaci√≥n inicial (MXN)</label>
          <input id="lumpSum" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="rate">Rendimiento anual esperado (nominal, %)</label>
          <input id="rate" type="number" value="10" min="0" max="100" step="0.01">
        </div>
        <div class="group">
          <label for="inflation">Inflaci√≥n promedio anual (%)</label>
          <input id="inflation" type="number" value="4" min="0" max="100" step="0.01">
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcBtn">Calcular</button>
        <button class="btn" id="resetBtn">Limpiar</button>
      </div>
    </div>

    <!-- Resultados Ahorro -->
    <div class="card">
      <h2>Resultados del ahorro</h2>
      <div class="kpis">
        <div class="kpi"><div class="kpi-label">Edad al finalizar aportaciones</div><div class="kpi-value" id="edadFinal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Ahorro acumulado (nominal)</div><div class="kpi-value" id="ahorroNominal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Total aportado</div><div class="kpi-value" id="totalAportado">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Rendimiento ganado</div><div class="kpi-value" id="rendimiento">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Fondo a los 65 (si aplica)</div><div class="kpi-value" id="fondo65">‚Äî</div></div>
      </div>

      <div class="toggle" id="toggleTable"><span><strong>Detalles a√±o por a√±o</strong></span><span>‚ñº</span></div>
      <div class="details" id="details">
        <table>
          <thead><tr><th>A√±o</th><th>Edad</th><th>Aportado ese a√±o</th><th>Saldo al cierre</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Panel B ¬∑ Pensi√≥n desde los 65 -->
    <div class="card">
      <h2>Panel B ¬∑ Pensi√≥n desde los 65</h2>
      <p class="help">La mensualidad se calcula en <strong>valor nominal (futuro)</strong> con el saldo a los 65 como base.</p>
      <div class="grid">
        <input type="hidden" id="pvRet" value="0">
        <div class="group">
          <label for="yrsRetSel">A√±os de retiro</label>
          <select id="yrsRetSel">
            <option value="15">15 a√±os</option>
            <option value="20" selected>20 a√±os</option>
            <option value="25">25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="rateRet">Rendimiento anual durante retiro (nominal, %)</label>
          <input id="rateRet" type="number" value="7" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="inflRet">Inflaci√≥n esperada (%)</label>
          <input id="inflRet" type="number" value="4" min="0" step="0.01">
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcRet">Calcular mensualidad</button>
      </div>

      <div class="kpis" id="retBox" style="display:none">
        <div class="kpi"><div class="kpi-label">Ingreso mensual estimado</div><div class="kpi-value" id="pmtReal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Meses de retiro</div><div class="kpi-value" id="nMeses">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Tasa real mensual</div><div class="kpi-value" id="iRealMes">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Regla 4% (referencia anual)</div><div class="kpi-value" id="rule4">‚Äî</div></div>
      </div>

      <!-- Detalle mes a mes (retiro) -->
      <div class="toggle" id="toggleRetTable"><span><strong>Detalle mes a mes (retiro)</strong></span><span>‚ñº</span></div>
      <div class="details" id="retDetails">
        <table>
          <thead>
            <tr>
              <th>Mes</th>
              <th>Saldo inicial</th>
              <th>Inter√©s del mes</th>
              <th>Retiro</th>
              <th>Saldo final</th>
            </tr>
          </thead>
          <tbody id="retBody"></tbody>
        </table>
      </div>
    </div>

    <div class="muted">Proyecci√≥n educativa; no contempla impuestos, comisiones u otros costos. Resultados no garantizados.</div>
  </div>

  <!-- WhatsApp -->
  <a id="waBtn" class="wa" target="_blank" rel="noopener">Chatear por WhatsApp</a>

  <!-- CTA SOLO PARA IMPRESI√ìN / PDF -->
  <div class="print-footer">
    <img src="./logo-garba.png" alt="GarBa Logo" />
    <div>
      GarBa ¬∑ Seguros con Estrategia ‚Äî ¬øNecesitas claridad para decidir?<br>
      Escr√≠beme: +52 662 417 6032 ¬∑ christian.garcia@sfgarba.com.mx
      <div class="print-date"></div>
    </div>
  </div>

<script>
  // ------- Utilidades
  const $ = id => document.getElementById(id);
  const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(v)||0);

  function linkWhatsApp(){
    const nombre = ($('nombreOpt').value||'').trim();
    const msg = [
      'Hola Christian, me interesa revisar mi plan.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos:*',
      `‚Ä¢ Edad: ${$('edad').value} a√±os`,
      `‚Ä¢ A√±os de aportaci√≥n: ${$('years').value}`,
      `‚Ä¢ Aportaci√≥n ${({'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'})[$('frequency').value]}: $${$('pmt').value}`
    ].filter(Boolean).join('\n');
    $('waBtn').href = 'https://wa.me/526624176032?text='+encodeURIComponent(msg);
  }

  // ------- Sugerencia PMT inicial (peras con peras)
  function calcSuggestion(){
    const edad   = parseFloat($('edadTop').value);
    const planY  = parseInt($('planTop').value,10);
    const meta0  = parseFloat($('metaHoy').value||0); // MXN de HOY
    const infl   = parseFloat($('inflation').value)/100; // usamos la misma inflaci√≥n
    const rAcc   = parseFloat($('rate').value)/100;      // misma tasa de acumulaci√≥n
    const rRet   = parseFloat($('rateRet').value)/100;   // misma tasa de retiro
    const yrsRet = parseInt($('yrsRetSel').value,10);

    if(!(edad>0 && planY>0 && meta0>0)){ $('sugBox').style.display='none'; $('insightBox').style.display='none'; return; }

    const yrsTo65 = Math.max(0,65-edad);
    const yrsAport = Math.min(planY, yrsTo65);             // se detiene a los 65
    const gapYears = Math.max(0, yrsTo65 - yrsAport);      // a√±os de crecimiento sin aportar

    // Trabajo en t√©rminos REALES para que el PMT inicial sea "de hoy" y luego se indexe con la inflaci√≥n
    const rAccReal = ((1+rAcc)/(1+infl))-1;
    const rRetReal = ((1+rRet)/(1+infl))-1;
    const iA = rAccReal/12, Nacc = Math.round(yrsAport*12);
    const iR = rRetReal/12, Nret = Math.round(yrsRet*12);

    // Capital REAL necesario a los 65 para pagar meta0 real cada mes por Nret
    const PVneed_real = Math.abs(iR)<1e-9 ? meta0*Nret : meta0*((1-Math.pow(1+iR,-Nret))/iR);

    // Lo que debe existir REAL al final de aportes (antes del gap) para que crezca hasta 65
    const FV_needed_end_real = PVneed_real / Math.pow(1+iA, gapYears*12);

    // PMT REAL constante mensual (aportaci√≥n de hoy) que alcanza ese FV en Nacc meses (fin de periodo)
    const factor = Math.abs(iA)<1e-9 ? Nacc : (Math.pow(1+iA,Nacc)-1)/iA;
    const PMT_real = FV_needed_end_real / (factor || 1);

    // El PMT que mostramos como "inicial" es ese valor real (de hoy). En la Fase 1 crecer√° a√±o con inflaci√≥n.
    const pmtInicial = Math.max(0, PMT_real);

    $('sugText').innerHTML =
      `üí° <strong>Proyecci√≥n personalizada:</strong> para lograr el ingreso que buscas en tu retiro, un <strong>ahorro mensual inicial de ${money(pmtInicial)}</strong> ser√≠a un buen punto de partida.<br>`+
      `<span style="font-size:12px;color:#cfd8e3">Es una gu√≠a; puedes iniciar desde $2,500 MXN al mes. Lo importante es empezar.${gapYears>0?` Tu fondo seguir√° creciendo <strong>${gapYears} a√±o(s)</strong> m√°s hasta los 65.`:''}</span>`;
    $('sugSup').innerText =
      `Supuestos de c√°lculo: inflaci√≥n ${(infl*100).toFixed(1)}%, rendimiento anual en acumulaci√≥n ${(rAcc*100).toFixed(1)}%, `+
      `retiro ${yrsRet} a√±os con rendimiento ${(rRet*100).toFixed(1)}% nominal.`;
    $('sugBox').style.display='block';
    $('insightBox').style.display='block';

    // Llevo ese PMT a la Fase 1 para que el usuario pueda probarlo de inmediato
    $('edad').value = String(edad);
    $('years').value = String(planY);
    $('pmt').value = String(pmtInicial.toFixed(2));
  }

  // ------- Fase 1 (acumulaci√≥n nominal con aportaci√≥n que sube por inflaci√≥n a√±o a a√±o)
  function calcAccum(){
    const edad = parseFloat($('edad').value);
    const years = parseFloat($('years').value);
    const pmt0 = parseFloat($('pmt').value);
    const lump = parseFloat($('lumpSum').value);
    const rate = parseFloat($('rate').value)/100;
    const freq = parseFloat($('frequency').value);
    const infl = parseFloat($('inflation').value)/100;

    if([edad,years,pmt0,lump,rate,freq,infl].some(x=>isNaN(x))){
      const e=$('errorMsg'); e.textContent='Completa todos los campos correctamente'; e.classList.add('show'); return;
    } else { $('errorMsg').classList.remove('show'); }

    const N = Math.round(years*freq);
    const i = rate/freq;

    // Aportaciones nominales: cada a√±o el pago sube por inflaci√≥n (pmt0, luego pmt0*(1+infl)^y)
    let FV_pmt = 0, total = lump, pmtYear = pmt0;

    for(let y=0;y<years;y++){
      if(y>0) pmtYear *= (1+infl);
      for(let p=0;p<freq;p++){
        const perRest = N - (y*freq + p);
        FV_pmt += pmtYear * Math.pow(1+i, perRest);
        total += pmtYear;
      }
    }
    const FV_nom_end = lump*Math.pow(1+i,N) + FV_pmt;
    const rend = FV_nom_end - total;
    const edadFin = edad + years;

    // Fondo a los 65 (si termina antes, se capitaliza hasta 65)
    let fondo65 = FV_nom_end;
    if(edadFin < 65){
      const extraYears = 65 - edadFin;
      const Nextra = Math.round(extraYears*freq);
      fondo65 = FV_nom_end * Math.pow(1+i, Nextra);
    }

    // KPIs
    $('edadFinal').textContent = String(Math.round(edadFin));
    $('ahorroNominal').textContent = money(FV_nom_end);
    $('totalAportado').textContent = money(total);
    $('rendimiento').textContent = money(rend);
    $('fondo65').textContent = money(fondo65);

    // Tabla a√±o a a√±o (nominal)
    const tbody=$('tbody'); tbody.innerHTML='';
    let saldo=lump, pmtY=pmt0, edadAct=edad;
    const totalYrs = Math.max(years, 65-edad); // mostramos hasta 65
    for(let yr=1; yr<=totalYrs; yr++){
      edadAct++;
      let aport=0;
      if(yr<=years){
        if(yr>1) pmtY *= (1+infl);
        aport = pmtY*freq;
        for(let k=0;k<freq;k++){ saldo = saldo*(1+i) + pmtY; }
      }else{
        for(let k=0;k<freq;k++){ saldo = saldo*(1+i); }
      }
      const tr=document.createElement('tr');
      if(yr>years) tr.style.background='rgba(11,94,215,.08)';
      tr.innerHTML=`<td>${yr}</td><td>${edadAct} a√±os</td><td>${yr>years?'‚Äî':money(aport)}</td><td>${money(saldo)}</td>`;
      tbody.appendChild(tr);
    }

    // Guardar saldo a los 65 para Fase 2 (peras con peras)
    $('pvRet').value = String(fondo65);
    linkWhatsApp();
  }

  // Construye la tabla mes a mes del retiro
  function buildRetSchedule(PV, iNom, PMT, n){
    const tbody = $('retBody');
    tbody.innerHTML = '';
    let saldo = PV;

    for(let m=1; m<=n; m++){
      const interes = saldo * iNom;
      const retiro  = PMT;
      const saldoFin = saldo + interes - retiro;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m}</td>
        <td>${money(saldo)}</td>
        <td>${money(interes)}</td>
        <td>${money(retiro)}</td>
        <td>${money(Math.max(0, saldoFin))}</td>
      `;
      tbody.appendChild(tr);

      saldo = saldoFin;
      if (saldo <= 0) break;
    }
  }

  // ------- Fase 2 (retiro desde el saldo a los 65, c√°lculo en NOMINAL)
  function calcRet(){
    const PV = parseFloat($('pvRet').value)||0;
    const yrs = parseInt($('yrsRetSel').value,10);
    const rateRet = parseFloat($('rateRet').value)/100;
    const infl = parseFloat($('inflRet').value)/100;

    if(PV<=0){ alert('Primero calcula tu ahorro (Panel A).'); return; }

    const iNom = rateRet/12, n = yrs*12;
    // PMT nominal constante (fin de periodo) que ‚Äúconsume‚Äù PV en n meses
    const PMT = Math.abs(iNom)<1e-9 ? PV/n : PV * ( iNom / (1 - Math.pow(1+iNom,-n)) );

    // Tasa real informativa
    const rReal = ((1+rateRet)/(1+infl))-1, iReal = rReal/12;

    $('retBox').style.display='grid';
    $('pmtReal').textContent = money(PMT);
    $('nMeses').textContent = `${n} meses`;
    $('iRealMes').textContent = `${(iReal*100).toFixed(3)}%`;
    $('rule4').textContent = `${money(PV*0.04)} /a√±o ¬∑ ${money(PV*0.04/12)} /mes`;

    // Detalle mes a mes (el saldo no retirado sigue generando rendimiento)
    buildRetSchedule(PV, iNom, PMT, n);
  }

  // ------- CSV
  function exportCSV(){
    const rows=[['A√±o','Edad','Aportado ese a√±o (MXN)','Saldo al cierre (MXN)']];
    document.querySelectorAll('#tbody tr').forEach(tr=>{
      const t=[...tr.querySelectorAll('td')].map(td=>td.textContent.replace(/[^\d.,\-a-z√± ]/gi,''));
      rows.push(t);
    });
    const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); const name=$('nombreOpt').value||'Proyeccion', f=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob); a.download=`${name}_corrida_${f}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // ------- Eventos
  $('planBtn').addEventListener('click', ()=>{ calcSuggestion(); calcAccum(); });
  $('resetTop').addEventListener('click', ()=>{
    $('nombreOpt').value=''; $('edadTop').value=29; $('planTop').value='25'; $('metaHoy').value=32000;
    $('sugBox').style.display='none'; $('insightBox').style.display='none';
  });

  $('calcBtn').addEventListener('click', calcAccum);
  $('resetBtn').addEventListener('click', ()=>{
    $('edad').value=29; $('years').value=25; $('pmt').value=2500; $('frequency').value=12; $('lumpSum').value=0;
    $('rate').value=10; $('inflation').value=4; calcAccum();
  });

  $('calcRet').addEventListener('click', calcRet);
  $('csvBtn').addEventListener('click', exportCSV);
  $('printBtn').addEventListener('click', ()=>{ 
    // Fecha autom√°tica en el pie
    const dateEl = document.querySelector('.print-footer .print-date');
    if (dateEl && !dateEl.textContent) {
      const fecha = new Date().toLocaleDateString('es-MX',{day:'2-digit',month:'long',year:'numeric'});
      dateEl.textContent = `Proyecci√≥n generada el ${fecha}`;
    }
    window.print(); 
  });
  $('toggleTable').addEventListener('click',()=>{ const d=$('details'); d.style.display=d.style.display==='block'?'none':'block'; });
  $('toggleRetTable').addEventListener('click',()=>{ const d=$('retDetails'); d.style.display=d.style.display==='block'?'none':'block'; });

  // recalcula autom√°ticamente cuando cambian supuestos relevantes
  ['edadTop','planTop','metaHoy','rate','inflation','rateRet','yrsRetSel'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcSuggestion(); });
  });
  ['edad','years','pmt','frequency','lumpSum','rate','inflation'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcAccum(); });
  });

  // init
  window.addEventListener('load', ()=>{ calcSuggestion(); calcAccum(); linkWhatsApp(); });
</script>
</body>
</html>
