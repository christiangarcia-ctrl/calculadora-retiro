<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#0B5ED7; 
    --brand-2:#084cc3;
    --ink:#0f172a; 
    --muted:#94a3b8;
    --paper:#111827; 
    --panel:#0b1324; 
    --line:rgba(255,255,255,.14);
    --wa:#25D366;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,#0b1223,#121a2f);
    color:#e5e7eb;
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1040px;margin:0 auto;padding:22px}

  /* WEB VIEW (pantalla) */
  .web-view{display:block}
  .report-view{display:none}

  /* Header */
  .header{
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:16px 18px;
    display:flex;
    align-items:center;
    gap:14px;
    box-shadow:0 8px 24px rgba(15,23,42,.16)
  }
  .brand img{height:56px;width:auto;display:block}
  .title{font-weight:800;font-size:22px;color:#0f172a}
  .sub{font-size:13px;color:#475569}
  .meta{margin-left:auto;text-align:right;font-size:14px;color:#111827;display:flex;gap:24px}
  .meta span{display:flex;gap:8px;align-items:center}

  /* Toolbar */
  .toolbar{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    margin:14px 0 18px
  }
  .btn{
    appearance:none;
    border:1px solid #e5e7eb;
    background:#fff;
    color:#0f172a;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    transition:.2s;
    font-size:14px;
  }
  .btn:hover{
    transform:translateY(-1px);
    box-shadow:0 6px 18px rgba(2,6,23,.10)
  }
  .btn-primary{
    background:var(--brand);
    border-color:var(--brand);
    color:#fff
  }
  .btn-primary:hover{background:var(--brand-2)}

  /* Banner comparativo */
  .banner-wrap{margin-top:16px;margin-bottom:18px}
  .banner-label{
    font-size:12px;
    color:#cbd5e1;
    margin-bottom:6px;
    font-weight:500;
  }
  .bars{
    display:grid;
    grid-template-columns:1fr 1.3fr;
    gap:10px;
  }
  .bar{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    padding:8px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:11px;
    letter-spacing:.4px;
    text-transform:uppercase;
  }
  .bar span:first-child{font-weight:600}
  .bar-afore{
    background:linear-gradient(90deg,#111827,#1f2937);
  }
  .bar-plan{
    background:linear-gradient(90deg,#e5f0ff,#c7d7ff);
    color:#0b1726;
    border-color:#93c5fd;
  }

  /* Cards */
  .card{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    border-radius:16px;
    padding:22px;
    margin:16px 0;
  }
  .card h2{
    margin:0 0 10px;
    color:#dbe3f3;
    font-size:20px;
    font-weight:800
  }
  .help{
    margin:-2px 0 14px;
    color:#cbd5e1;
    font-size:13px
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
    gap:14px
  }
  .group{display:flex;flex-direction:column}
  label{
    font-size:12px;
    color:#cbd5e1;
    margin-bottom:6px;
    font-weight:600
  }
  input,select{
    padding:12px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.05);
    color:#fff;
    border-radius:10px;
    font-size:16px;
    transition:border .15s, box-shadow .15s
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(11,94,215,.25)
  }
  .muted{
    font-size:12px;
    color:#94a3b8;
    margin-top:6px
  }

  /* Sugerencia */
  .suggest{
    display:none;
    border:1px solid rgba(11,94,215,.35);
    background:linear-gradient(0deg,rgba(11,94,215,.10),rgba(11,94,215,.10));
    border-left:6px solid var(--brand);
    border-radius:14px;
    padding:14px;
    margin-top:12px
  }
  .suggest strong{color:#eaf2ff}

  /* KPIs */
  .kpis{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
    margin-top:6px
  }
  .kpi{
    background:rgba(255,255,255,.06);
    border:1px solid var(--line);
    border-radius:14px;
    padding:16px
  }
  .kpi-label{
    font-size:11px;
    letter-spacing:.4px;
    color:#a9b4c7;
    text-transform:uppercase
  }
  .kpi-value{
    font-size:22px;
    font-weight:800;
    color:#f8fafc
  }

  /* Fiscal card */
  .fiscal-card{
    margin-top:16px;
    padding:14px;
    border-radius:12px;
    border:1px dashed rgba(148,163,184,.6);
    background:rgba(15,23,42,.65);
    font-size:13px;
  }
  .fiscal-inline{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:10px;
  }
  .pill-label{
    font-size:12px;
    font-weight:600;
    margin-bottom:4px;
    color:#cbd5e1;
  }
  .pill{
    display:flex;
    flex-direction:column;
    min-width:140px;
  }
  .pill input[type="checkbox"]{
    width:auto;
    margin-right:6px;
  }
  .pill-row{
    display:flex;
    align-items:center;
    gap:6px;
    margin-top:4px;
    font-size:12px;
    color:#cbd5e1;
  }

  /* Tables / toggles web */
  .toggle{
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    border:1px solid var(--line);
    padding:12px 14px;
    border-radius:12px;
    margin-top:10px
  }
  .details{display:none;overflow:auto}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px
  }
  th{
    background:rgba(255,255,255,.08);
    text-align:left;
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.14);
    font-size:13px
  }
  td{
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.08);
    font-size:14px
  }

  /* WhatsApp */
  .wa{
    position:fixed;
    right:18px;
    bottom:22px;
    background:var(--wa);
    color:#06371a;
    border-radius:999px;
    padding:12px 16px;
    font-weight:800;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    font-size:14px;
  }

  .error{
    display:none;
    background:rgba(220,53,69,.18);
    border:1px solid rgba(220,53,69,.4);
    color:#fecaca;
    padding:10px;
    border-radius:10px;
    margin:8px 0
  }

  /* ============= ESTILO PDF / IMPRESI√ìN (EXECUTIVE REPORT) ============= */

  @media print{
    body{
      background:#ffffff !important;
      color:#000000 !important;
      -webkit-print-color-adjust:exact;
      print-color-adjust:exact;
      font-size:12px;
    }
    .web-view,
    .wa{
      display:none !important;
    }
    .report-view{
      display:block !important;
      max-width:800px;
      margin:0 auto;
      padding:12mm 10mm 18mm;
    }
    .report-header{
      border-bottom:1px solid #d1d5db;
      padding-bottom:10px;
      margin-bottom:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .report-header-left{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .report-logo img{
      height:48px;
      width:auto;
    }
    .report-title{
      font-size:18px;
      font-weight:800;
      color:#111827;
    }
    .report-sub{
      font-size:11px;
      color:#4b5563;
    }
    .report-meta{
      font-size:10px;
      color:#6b7280;
      text-align:right;
    }
    .report-section{
      margin-bottom:14px;
      page-break-inside:avoid;
    }
    .report-section h3{
      font-size:13px;
      font-weight:700;
      color:#111827;
      margin:0 0 4px;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .report-section p{
      margin:2px 0;
      font-size:11px;
      color:#111827;
    }
    .report-grid-2{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:8px;
    }
    .r-label{font-size:11px;color:#4b5563}
    .r-value{font-size:12px;font-weight:600;color:#111827}
    .r-small{font-size:10px;color:#6b7280;margin-top:2px}
    .report-table{
      width:100%;
      border-collapse:collapse;
      margin-top:4px;
      font-size:10.5px;
    }
    .report-table th{
      border-bottom:1px solid #d1d5db;
      text-align:left;
      padding:4px 3px;
      font-weight:600;
      color:#111827;
    }
    .report-table td{
      border-bottom:1px solid #e5e7eb;
      padding:4px 3px;
      color:#111827;
    }
    .report-note{
      font-size:10px;
      color:#6b7280;
      margin-top:4px;
    }
    .report-quote{
      border-left:3px solid #9ca3af;
      padding-left:8px;
      margin-top:4px;
      font-size:11px;
      color:#111827;
      font-style:italic;
    }
    .report-footer{
      border-top:1px solid #d1d5db;
      margin-top:10px;
      padding-top:6px;
      font-size:9.5px;
      color:#6b7280;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
  }
</style>
</head>
<body>
<div class="container">

  <!-- =============== VISTA WEB INTERACTIVA =============== -->
  <div class="web-view">

    <!-- Acciones -->
    <div class="toolbar">
      <button class="btn" id="csvBtn">Exportar CSV</button>
      <button class="btn btn-primary" id="printBtn">Imprimir / Guardar PDF</button>
    </div>

    <!-- Encabezado -->
    <div class="header">
      <div class="brand">
        <img src="./logo-garba.png" alt="Christian GarBa">
      </div>
      <div>
        <div class="title">Christian GarBa</div>
        <div class="sub">Seguros con Estrategia</div>
      </div>
      <div class="meta">
        <span>üìû 662 417 6032</span>
        <span>‚úâÔ∏è christian.garcia@sfgarba.com.mx</span>
      </div>
    </div>

    <!-- Barras comparativas AFORE vs Plan -->
    <div class="banner-wrap">
      <div class="banner-label">Comparativo r√°pido</div>
      <div class="bars">
        <div class="bar bar-afore">
          <span>AFORE (Ley 97 en adelante)</span>
          <span>Ingreso limitado, sin estrategia</span>
        </div>
        <div class="bar bar-plan">
          <span>Proyecci√≥n personalizada GarBa</span>
          <span>Ingreso dise√±ado a tu medida</span>
        </div>
      </div>
    </div>

    <!-- Panel A -->
    <div class="card">
      <h2>Panel A ¬∑ Punto de partida</h2>
      <div class="help">
        Definimos la meta y te sugerimos una aportaci√≥n mensual inicial.  
        La edad de retiro considerada es <strong>65 a√±os</strong>.
      </div>
      <div class="grid">
        <div class="group">
          <label for="nombreOpt">Tu nombre (opcional)</label>
          <input id="nombreOpt" type="text" placeholder="Ej. Fernanda">
        </div>
        <div class="group">
          <label for="edadTop">Edad actual (a√±os)</label>
          <input id="edadTop" type="number" min="18" max="100" value="29">
        </div>
        <div class="group">
          <label for="planTop">A√±os de plan (aportando)</label>
          <select id="planTop">
            <option value="15">15 a√±os</option>
            <option value="20">20 a√±os</option>
            <option value="25" selected>25 a√±os</option>
          </select>
        </div>
        <div class="group" style="grid-column:1/-1">
          <label for="metaHoy">Ingreso mensual que te gustar√≠a en tu retiro (MXN, valor de hoy)</label>
          <input id="metaHoy" type="number" min="0" step="1000" placeholder="Ej. 32,000" value="32000">
          <div class="muted">
            Usamos este dato como referencia para estimar cu√°nto tendr√≠as que ahorrar para acercarte a ese nivel de ingreso.
          </div>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="planBtn">Calcular plan sugerido</button>
        <button class="btn" id="resetTop">Reiniciar datos</button>
      </div>

      <div class="suggest" id="sugBox">
        <div id="sugText"></div>
        <div class="muted" id="sugSup"></div>
      </div>
    </div>

    <!-- Fase 1 -->
    <div class="card">
      <h2>Fase 1 ‚Ä¢ Ahorro con inter√©s compuesto</h2>
      <p class="help">
        Tus aportaciones crecen cada a√±o seg√∫n inflaci√≥n. El fondo sigue invertido hasta los 65 a√±os aunque dejes de aportar antes.
      </p>
      <div class="error" id="errorMsg"></div>
      <div class="grid">
        <div class="group">
          <label for="edad">Edad actual (a√±os)</label>
          <input id="edad" type="number" value="29" min="18" max="100">
        </div>
        <div class="group">
          <label for="years">A√±os que aportar√°s</label>
          <input id="years" type="number" value="25" min="1" max="70">
        </div>
        <div class="group">
          <label for="pmt">Aportaci√≥n peri√≥dica inicial (MXN)</label>
          <input id="pmt" type="number" value="2500" min="0" step="0.01">
          <div class="muted">Se actualiza cada a√±o aproximadamente con la inflaci√≥n.</div>
        </div>
        <div class="group">
          <label for="frequency">Frecuencia de aportaci√≥n</label>
          <select id="frequency">
            <option value="12" selected>Mensual</option>
            <option value="4">Trimestral</option>
            <option value="2">Semestral</option>
            <option value="1">Anual</option>
          </select>
        </div>
        <div class="group">
          <label for="lumpSum">Aportaci√≥n inicial √∫nica (MXN)</label>
          <input id="lumpSum" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="rate">Rendimiento anual esperado (nominal, %)</label>
          <input id="rate" type="number" value="10" min="0" max="100" step="0.01">
        </div>
        <div class="group">
          <label for="inflation">Inflaci√≥n promedio anual (%)</label>
          <input id="inflation" type="number" value="4" min="0" max="100" step="0.01">
        </div>
      </div>

      <!-- M√ìDULO FISCAL (Fase de acumulaci√≥n) -->
      <div class="fiscal-card">
        <strong>Tratamiento fiscal (opcional)</strong>
        <div class="muted">
          Solo se considera en la fase de ahorro (hasta los 65 a√±os). No se modelan impuestos durante el retiro.
        </div>
        <div class="fiscal-inline">
          <div class="pill">
            <span class="pill-label">R√©gimen</span>
            <select id="regimenFiscal">
              <option value="ninguno">Sin beneficio fiscal inmediato</option>
              <option value="93">Art. 93 (no deducible, diferido)</option>
              <option value="151">Art. 151 (deducible anual)</option>
            </select>
          </div>
          <div class="pill">
            <span class="pill-label">% estimado de devoluci√≥n ISR (sobre aportaci√≥n anual)</span>
            <select id="isrPct">
              <option value="0">0% (no reinvertir / no aplica)</option>
              <option value="10">10%</option>
              <option value="20" selected>20%</option>
              <option value="30">30%</option>
              <option value="35">35%</option>
            </select>
          </div>
          <div class="pill">
            <span class="pill-label">Uso de la devoluci√≥n</span>
            <div class="pill-row">
              <input id="reinvertISR" type="checkbox" checked>
              <label for="reinvertISR" style="margin:0;font-weight:500;font-size:12px;">Reinvertir devoluci√≥n en el plan</label>
            </div>
          </div>
        </div>
        <div class="muted" style="margin-top:6px;">
          Aproximaci√≥n educativa. El c√°lculo real de ISR depende de tu situaci√≥n fiscal y topes de deducci√≥n.
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcBtn">Calcular</button>
        <button class="btn" id="resetBtn">Limpiar</button>
      </div>
    </div>

    <!-- Resultados Fase 1 -->
    <div class="card">
      <h2>Resultados de la Fase 1</h2>
      <div class="kpis">
        <div class="kpi">
          <div class="kpi-label">Edad al finalizar aportaciones</div>
          <div class="kpi-value" id="edadFinal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Ahorro acumulado al final del plan</div>
          <div class="kpi-value" id="ahorroNominal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total aportado de tu bolsillo</div>
          <div class="kpi-value" id="totalAportado">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Rendimiento / beneficio</div>
          <div class="kpi-value" id="rendimiento">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Fondo estimado a los 65 a√±os</div>
          <div class="kpi-value" id="fondo65">‚Äî</div>
        </div>
        <div class="kpi" id="kpiFiscalBox" style="display:none">
          <div class="kpi-label">Beneficio fiscal reinvertido</div>
          <div class="kpi-value" id="benefFiscal">‚Äî</div>
        </div>
      </div>

      <div class="toggle" id="toggleTable">
        <span><strong>Detalles a√±o por a√±o</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="details">
        <table>
          <thead>
          <tr>
            <th>A√±o</th>
            <th>Edad</th>
            <th>Aportado ese a√±o</th>
            <th>Beneficio fiscal reinvertido</th>
            <th>Saldo al cierre</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Fase 2 -->
    <div class="card">
      <h2>Fase 2 ‚Ä¢ Mensualidad de retiro</h2>
      <p class="help">
        La mensualidad se calcula a partir del fondo estimado a los 65 a√±os.  
        No se modelan impuestos en la etapa de retiro; el enfoque es educativo.
      </p>
      <div class="grid">
        <input type="hidden" id="pvRet" value="0">
        <div class="group">
          <label for="yrsRetSel">A√±os de retiro</label>
          <select id="yrsRetSel">
            <option value="15">15 a√±os</option>
            <option value="20" selected>20 a√±os</option>
            <option value="25">25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="rateRet">Rendimiento anual durante retiro (nominal, %)</label>
          <input id="rateRet" type="number" value="7" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="inflRet">Inflaci√≥n esperada (%)</label>
          <input id="inflRet" type="number" value="4" min="0" step="0.01">
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcRet">Calcular mensualidad</button>
      </div>

      <div class="kpis" id="retBox" style="display:none">
        <div class="kpi">
          <div class="kpi-label">Ingreso mensual estimado</div>
          <div class="kpi-value" id="pmtReal">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Meses de retiro</div>
          <div class="kpi-value" id="nMeses">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Tasa real mensual aprox.</div>
          <div class="kpi-value" id="iRealMes">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Referencia regla 4% (anual)</div>
          <div class="kpi-value" id="rule4">‚Äî</div>
        </div>
      </div>

      <!-- Detalle mensual retiro -->
      <div class="toggle" id="toggleTableRet">
        <span><strong>Detalle mensual del retiro</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="detailsRet">
        <table>
          <thead>
          <tr>
            <th>Mes</th>
            <th>Edad</th>
            <th>Retiro del mes</th>
            <th>Inter√©s del mes</th>
            <th>Saldo al cierre</th>
          </tr>
          </thead>
          <tbody id="tbodyRet"></tbody>
        </table>
      </div>
    </div>

    <div class="muted">
      Proyecci√≥n educativa; no contempla comisiones espec√≠ficas, cambios regulatorios ni impuestos en la fase de retiro. Resultados no garantizados.
    </div>
  </div>

  <!-- =============== VISTA PDF / INFORME EJECUTIVO (SOLO IMPRESI√ìN) =============== -->
  <div class="report-view">
    <div class="report-header">
      <div class="report-header-left">
        <div class="report-logo">
          <img src="./logo-garba.png" alt="Christian GarBa">
        </div>
        <div>
          <div class="report-title">Plan de Ahorro y Retiro Personalizado</div>
          <div class="report-sub">Proyecci√≥n financiera basada en supuestos conservadores</div>
        </div>
      </div>
      <div class="report-meta">
        <div id="rptFecha"></div>
        <div>Asesor: Christian GarBa</div>
        <div>Seguros con Estrategia</div>
      </div>
    </div>

    <!-- Secci√≥n 1: Datos del cliente -->
    <div class="report-section">
      <h3>1. Datos del cliente y objetivo</h3>
      <div class="report-grid-2">
        <div>
          <p><span class="r-label">Nombre:</span> <span class="r-value" id="rptNombre">‚Äî</span></p>
          <p><span class="r-label">Edad actual:</span> <span class="r-value" id="rptEdad">‚Äî</span></p>
          <p><span class="r-label">Meta mensual (valor de hoy):</span> <span class="r-value" id="rptMetaHoy">‚Äî</span></p>
          <p><span class="r-label">Horizonte de aportaci√≥n:</span> <span class="r-value" id="rptPlazo">‚Äî</span></p>
          <p><span class="r-label">Aportaci√≥n inicial sugerida:</span> <span class="r-value" id="rptAportSug">‚Äî</span></p>
        </div>
        <div>
          <p class="r-label">Supuestos principales:</p>
          <p class="r-small" id="rptSupuestos1">‚Äî</p>
          <p class="r-small" id="rptSupuestosFiscal">‚Äî</p>
        </div>
      </div>
    </div>

    <!-- Secci√≥n 2: Acumulaci√≥n -->
    <div class="report-section">
      <h3>2. Fase de acumulaci√≥n hasta los 65 a√±os</h3>
      <table class="report-table">
        <tr>
          <th>Concepto</th>
          <th>Monto estimado</th>
        </tr>
        <tr>
          <td>Total aportado de tu bolsillo</td>
          <td id="rptTotalAportado">‚Äî</td>
        </tr>
        <tr>
          <td>Beneficio / rendimiento sobre tus aportaciones</td>
          <td id="rptRendimiento">‚Äî</td>
        </tr>
        <tr>
          <td>Fondo estimado al terminar el plan</td>
          <td id="rptAhorroNominal">‚Äî</td>
        </tr>
        <tr>
          <td>Proyecci√≥n de fondo a los 65 a√±os</td>
          <td id="rptFondo65">‚Äî</td>
        </tr>
        <tr id="rptFilaFiscal" style="display:none">
          <td>Beneficio fiscal reinvertido estimado</td>
          <td id="rptBenefFiscal">‚Äî</td>
        </tr>
      </table>
      <p class="report-note">
        La proyecci√≥n asume que mantienes el plan sin interrupciones y que los rendimientos e inflaci√≥n se comportan en promedio como se indica en los supuestos.
      </p>
    </div>

    <!-- Secci√≥n 3: Ingreso de retiro -->
    <div class="report-section">
      <h3>3. Fase de retiro</h3>
      <div class="report-grid-2">
        <div>
          <p><span class="r-label">Ingreso mensual estimado:</span> <span class="r-value" id="rptIngresoMensual">‚Äî</span></p>
          <p><span class="r-label">Duraci√≥n estimada del retiro:</span> <span class="r-value" id="rptDuracion">‚Äî</span></p>
          <p><span class="r-label">Tasa real mensual aproximada:</span> <span class="r-value" id="rptTasaReal">‚Äî</span></p>
        </div>
        <div>
          <p class="r-label">Referencia de prudencia:</p>
          <p class="r-small" id="rptRegla4">‚Äî</p>
        </div>
      </div>
    </div>

    <!-- Secci√≥n 4: Costo de posponer la decisi√≥n -->
    <div class="report-section">
      <h3>4. Costo de posponer el inicio del plan</h3>
      <table class="report-table">
        <thead>
        <tr>
          <th>Momento en que inicias</th>
          <th>Aportaci√≥n mensual inicial estimada</th>
          <th>Incremento vs. empezar hoy</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>Empiezas hoy</td>
          <td id="rptHoyMonto">‚Äî</td>
          <td id="rptHoyDelta">‚Äî</td>
        </tr>
        <tr>
          <td>Si decides empezar dentro de 1 a√±o</td>
          <td id="rpt1Monto">‚Äî</td>
          <td id="rpt1Delta">‚Äî</td>
        </tr>
        <tr>
          <td>Si decides empezar dentro de 3 a√±os</td>
          <td id="rpt3Monto">‚Äî</td>
          <td id="rpt3Delta">‚Äî</td>
        </tr>
        <tr>
          <td>Si decides empezar dentro de 5 a√±os</td>
          <td id="rpt5Monto">‚Äî</td>
          <td id="rpt5Delta">‚Äî</td>
        </tr>
        </tbody>
      </table>
      <p class="report-quote" id="rptMensajePosponer">
        ‚Äî 
      </p>
    </div>

    <!-- Secci√≥n 5: Mensaje final -->
    <div class="report-section">
      <h3>5. Comentario estrat√©gico</h3>
      <p class="report-note" id="rptComentario">
        Este documento tiene fines informativos y de planeaci√≥n. El siguiente paso es ajustar el plan a tu realidad de ingresos, obligaciones y prioridades familiares para que sea sostenible en el tiempo.
      </p>
    </div>

    <div class="report-footer">
      <div>
        Christian GarBa ¬∑ Seguros con Estrategia  
        Tel. 662 417 6032 ¬∑ christian.garcia@sfgarba.com.mx
      </div>
      <div>
        Proyecci√≥n ilustrativa. No constituye oferta vinculante ni garantiza rendimientos futuros.
      </div>
    </div>
  </div>

</div>

<!-- WhatsApp -->
<a id="waBtn" class="wa" target="_blank" rel="noopener">Chatear por WhatsApp</a>

<script>
  const $ = id => document.getElementById(id);
  const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(v)||0);

  const freqMap = {'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'};

  const reportState = {
    nombre:'',
    edad:null,
    metaHoy:null,
    planYears:null,
    pmtSugerido:null,
    infl:null,
    rAcc:null,
    rRet:null,
    yrsRet:null,
    totalAportado:0,
    rendimiento:0,
    ahorroNominal:0,
    fondo65:0,
    benefFiscal:0,
    ingresoMensual:0,
    tasaRealMes:0,
    regimenFiscal:'ninguno',
    isrPct:0,
    delayScenarios:null
  };

  function linkWhatsApp(){
    const nombre = ($('nombreOpt').value||'').trim();
    const msg = [
      'Hola Christian, me interesa revisar mi plan de retiro.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos:*',
      `‚Ä¢ Edad: ${$('edad').value} a√±os`,
      `‚Ä¢ A√±os de aportaci√≥n: ${$('years').value}`,
      `‚Ä¢ Aportaci√≥n ${freqMap[$('frequency').value]}: $${$('pmt').value}`
    ].filter(Boolean).join('\n');
    $('waBtn').href = 'https://wa.me/526624176032?text='+encodeURIComponent(msg);
  }

  // ---------- Funci√≥n base para PMT requerido dado edad de inicio ----------
  function calcularPMTRequerido(edadInicio, planY, metaHoy, infl, rAcc, rRet, yrsRet, freq){
    if(!(edadInicio>0 && planY>0 && metaHoy>0)) return 0;

    const yrsTo65   = Math.max(0, 65 - edadInicio);
    const yrsAport  = Math.min(planY, yrsTo65);
    const gapYears  = Math.max(0, yrsTo65 - yrsAport);

    if(yrsAport<=0) return 0;

    const inflDec   = infl/100;
    const rAccDec   = rAcc/100;
    const rRetDec   = rRet/100;

    // 1) Meta nominal a los 65
    const metaNom65 = metaHoy * Math.pow(1+inflDec, yrsTo65);

    // 2) Capital requerido a los 65 para pagar esa renta
    const iRet = rRetDec/freq;
    const nRet = yrsRet*freq;
    const PVneed65 = Math.abs(iRet)<1e-12 ? metaNom65*nRet
                    : metaNom65 * ( (1 - Math.pow(1+iRet, -nRet)) / iRet );

    // 3) Factor de aportaciones que suben ‚âà inflaci√≥n
    const iAcc = rAccDec/freq;
    const N    = yrsAport*freq;
    let FV_pagos = 0, pmtYear = 1;
    for(let y=0; y<yrsAport; y++){
      if(y>0) pmtYear *= (1+inflDec);
      for(let m=0; m<freq; m++){
        const perRest = N - (y*freq + m);
        FV_pagos += pmtYear * Math.pow(1+iAcc, perRest);
      }
    }
    const growTo65    = Math.pow(1+iAcc, gapYears*freq);
    const totalFactor = FV_pagos * growTo65;
    if(totalFactor<=0) return 0;
    return PVneed65 / totalFactor;
  }

  // ---------- Sugerencia Panel A + escenarios de posponer ----------
  function calcSuggestion(){
    const edadTop   = parseFloat($('edadTop').value);
    const planY     = parseInt($('planTop').value,10);
    const metaHoy   = parseFloat($('metaHoy').value||0);
    const infl      = parseFloat($('inflation').value);
    const rAcc      = parseFloat($('rate').value);
    const rRet      = parseFloat($('rateRet').value||7);
    const yrsRet    = parseInt($('yrsRetSel').value||20,10);
    const freq      = 12;

    if(!(edadTop>0 && planY>0 && metaHoy>0)){
      $('sugBox').style.display='none';
      return;
    }

    const pmt0 = calcularPMTRequerido(edadTop, planY, metaHoy, infl, rAcc, rRet, yrsRet, freq);
    const yrsTo65 = Math.max(0,65-edadTop);
    const gapYears = Math.max(0, yrsTo65 - Math.min(planY, yrsTo65));

    // escenarios de posponer
    const delays = [0,1,3,5];
    const escenarios = {};
    delays.forEach(d=>{
      const pmtd = calcularPMTRequerido(edadTop + d, planY, metaHoy, infl, rAcc, rRet, yrsRet, freq);
      escenarios[d] = pmtd;
    });

    // Copy sugerencia
    const yrsTexto = gapYears>0 ? ` Tu fondo podr√≠a seguir creciendo aproximadamente ${gapYears} a√±o(s) m√°s hasta los 65, aunque termines de aportar antes.` : '';
    $('sugText').innerHTML =
      `üí° <strong>Proyecci√≥n personalizada:</strong> para acercarte al ingreso que buscas en tu retiro, `+
      `un <strong>ahorro mensual inicial de ${money(pmt0)}</strong> ser√≠a un punto de partida razonable.`+
      `<br><span style="font-size:12px;color:#cfd8e3">Lo importante es iniciar; el plan siempre se puede ajustar contigo en asesor√≠a uno a uno.${yrsTexto}</span>`;

    $('sugSup').innerText =
      `Supuestos: inflaci√≥n ${(infl).toFixed(1)}%, rendimiento en acumulaci√≥n ${(rAcc).toFixed(1)}% nominal, `+
      `retiro de ${yrsRet} a√±os con ${(rRet).toFixed(1)}% nominal.`;

    $('sugBox').style.display='block';

    // Precarga Fase 1 con PMT sugerido
    $('edad').value  = String(edadTop);
    $('years').value = String(planY);
    $('pmt').value   = String(pmt0.toFixed(2));

    // Guardamos en estado de reporte (base)
    reportState.metaHoy   = metaHoy;
    reportState.planYears = planY;
    reportState.pmtSugerido = pmt0;
    reportState.infl      = infl;
    reportState.rAcc      = rAcc;
    reportState.rRet      = rRet;
    reportState.yrsRet    = yrsRet;
    reportState.delayScenarios = escenarios;

    actualizarSeccionPosponer();
  }

  // ---------- Fase 1: simulaci√≥n con reinversi√≥n ISR opcional ----------
  function calcAccum(){
    const edad   = parseFloat($('edad').value);
    const years  = parseFloat($('years').value);
    const pmt0   = parseFloat($('pmt').value);
    const lump   = parseFloat($('lumpSum').value);
    const rate   = parseFloat($('rate').value)/100;
    const freq   = parseFloat($('frequency').value);
    const infl   = parseFloat($('inflation').value)/100;

    const regimen = $('regimenFiscal').value;
    const isrPct  = parseFloat($('isrPct').value)/100;
    const reinv   = $('reinvertISR').checked;

    if([edad,years,pmt0,lump,rate,freq,infl].some(x=>isNaN(x))){
      const e=$('errorMsg');
      e.textContent='Completa todos los campos correctamente.';
      e.style.display='block';
      return;
    }else{
      $('errorMsg').style.display='none';
    }

    const yrsTo65   = Math.max(0,65-edad);
    const yrsAport  = years;
    const yrsExtra  = Math.max(0, yrsTo65 - yrsAport); // a√±os s√≥lo invirtiendo

    const i = rate/freq;

    let saldo = lump;
    let totalAportado = lump;
    let benefFiscal = 0;
    let edadAct = edad;
    let pmtYear = pmt0;
    let fvEndPlan = lump;
    const tbody = $('tbody');
    tbody.innerHTML='';

    const totalYearsSim = yrsAport + yrsExtra;

    for(let yr=1; yr<=totalYearsSim; yr++){
      edadAct++;
      let aportAno = 0;
      let benefAno = 0;

      if(yr<=yrsAport){
        if(yr>1) pmtYear *= (1+infl);
        for(let k=0;k<freq;k++){
          saldo *= (1+i);
          saldo += pmtYear;
          aportAno += pmtYear;
          totalAportado += pmtYear;
        }
        if(regimen==='151' && reinv && isrPct>0){
          benefAno = aportAno * isrPct;
          saldo += benefAno;
          benefFiscal += benefAno;
        }
      }else{
        for(let k=0;k<freq;k++){
          saldo *= (1+i);
        }
      }

      if(yr===yrsAport){
        fvEndPlan = saldo;
      }

      const tr = document.createElement('tr');
      if(yr>yrsAport) tr.style.background='rgba(148,163,184,.16)';
      tr.innerHTML = `
        <td>${yr}</td>
        <td>${edadAct} a√±os</td>
        <td>${yr>yrsAport?'‚Äî':money(aportAno)}</td>
        <td>${benefAno>0?money(benefAno):'‚Äî'}</td>
        <td>${money(saldo)}</td>
      `;
      tbody.appendChild(tr);
    }

    const ahorroNominal = fvEndPlan;
    const fondo65 = saldo;
    const rendimiento = ahorroNominal - totalAportado;

    $('edadFinal').textContent   = String(Math.round(edad + yrsAport));
    $('ahorroNominal').textContent = money(ahorroNominal);
    $('totalAportado').textContent = money(totalAportado);
    $('rendimiento').textContent   = money(rendimiento);
    $('fondo65').textContent       = money(fondo65);
    $('pvRet').value = String(fondo65);

    if(benefFiscal>0){
      $('kpiFiscalBox').style.display='block';
      $('benefFiscal').textContent = money(benefFiscal);
    }else{
      $('kpiFiscalBox').style.display='none';
      $('benefFiscal').textContent = '‚Äî';
    }

    // Actualizamos estado reporte
    reportState.edad          = edad;
    reportState.totalAportado = totalAportado;
    reportState.rendimiento   = rendimiento;
    reportState.ahorroNominal = ahorroNominal;
    reportState.fondo65       = fondo65;
    reportState.benefFiscal   = benefFiscal;
    reportState.regimenFiscal = regimen;
    reportState.isrPct        = isrPct*100;

    actualizarReporteBase();
    linkWhatsApp();
  }

  // ---------- Fase 2: retiro ----------
  function calcRet(){
    const PV   = parseFloat($('pvRet').value)||0;
    const yrs  = parseInt($('yrsRetSel').value,10);
    const rateRet = parseFloat($('rateRet').value)/100;
    const infl = parseFloat($('inflRet').value)/100;

    if(PV<=0){
      alert('Primero calcula tu ahorro (Fase 1).');
      return;
    }

    const iNom = rateRet/12;
    const n    = yrs*12;
    const PMT  = Math.abs(iNom)<1e-9 ? PV/n : PV * ( iNom / (1 - Math.pow(1+iNom,-n)) );

    const rReal = ((1+rateRet)/(1+infl))-1;
    const iReal = rReal/12;

    $('retBox').style.display='grid';
    $('pmtReal').textContent = money(PMT);
    $('nMeses').textContent  = `${n} meses`;
    $('iRealMes').textContent = `${(iReal*100).toFixed(3)}%`;
    $('rule4').textContent   = `${money(PV*0.04)} /a√±o ¬∑ ${money(PV*0.04/12)} /mes`;

    // Detalle mensual
    const tbodyRet = $('tbodyRet');
    tbodyRet.innerHTML='';
    let saldo = PV;
    for(let m=1; m<=n; m++){
      const interes = saldo * iNom;
      const saldoAntes = saldo + interes;
      const retiro = PMT;
      const saldoDesp = Math.max(0, saldoAntes - retiro);

      const yearsAdd = Math.floor(m/12);
      const monthsRem = m % 12;
      const edadTxt = `${65 + yearsAdd} a√±os${monthsRem?` ${monthsRem} mes(es)`:''}`;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${m}</td>
        <td>${edadTxt}</td>
        <td>${money(retiro)}</td>
        <td>${money(interes)}</td>
        <td>${money(saldoDesp)}</td>
      `;
      tbodyRet.appendChild(tr);
      saldo = saldoDesp;
    }

    // Reporte
    reportState.ingresoMensual = PMT;
    reportState.yrsRet         = yrs;
    reportState.tasaRealMes    = iReal;
    actualizarReporteBase();
  }

  // ---------- Secci√≥n de posponer en reporte ----------
  function actualizarSeccionPosponer(){
    const esc = reportState.delayScenarios;
    if(!esc || reportState.pmtSugerido==null) return;

    const base = esc[0] || 0;
    function deltaTxt(pmtDelay){
      if(!base || !pmtDelay) return '‚Äî';
      const diff = pmtDelay - base;
      if(diff<=0) return 'Igual que hoy';
      const pct  = diff/base*100;
      return `${money(diff)} (+${pct.toFixed(1)}%)`;
    }

    $('rptHoyMonto').textContent = base?money(base):'‚Äî';
    $('rptHoyDelta').textContent = '‚Äî';
    $('rpt1Monto').textContent   = esc[1]?money(esc[1]):'‚Äî';
    $('rpt1Delta').textContent   = deltaTxt(esc[1]);
    $('rpt3Monto').textContent   = esc[3]?money(esc[3]):'‚Äî';
    $('rpt3Delta').textContent   = deltaTxt(esc[3]);
    $('rpt5Monto').textContent   = esc[5]?money(esc[5]):'‚Äî';
    $('rpt5Delta').textContent   = deltaTxt(esc[5]);

    const nombre = (reportState.nombre||'').trim() || 'T√∫';
    $('rptMensajePosponer').textContent =
      `${nombre}, el futuro que hoy est√°s proyectando tiene un "precio" en t√©rminos de ahorro mensual. `+
      `Si postergas tu decisi√≥n 1, 3 o 5 a√±os, el esfuerzo mensual requerido aumenta de forma importante. `+
      `Empezar antes casi siempre es m√°s barato que corregir despu√©s.`;
  }

  // ---------- Relleno de secciones del reporte ----------
  function actualizarReporteBase(){
    const nombre = ($('nombreOpt').value||'').trim();
    reportState.nombre = nombre;

    const hoy = new Date();
    $('rptFecha').textContent = `Fecha de proyecci√≥n: ${hoy.toLocaleDateString('es-MX')}`;
    $('rptNombre').textContent = nombre || '‚Äî';

    if(reportState.edad!=null){
      $('rptEdad').textContent = `${reportState.edad} a√±os`;
    }else{
      const eTop = parseFloat($('edadTop').value||0);
      $('rptEdad').textContent = eTop?`${eTop} a√±os`:'‚Äî';
    }

    if(reportState.metaHoy!=null){
      $('rptMetaHoy').textContent = money(reportState.metaHoy);
    }else{
      const mH = parseFloat($('metaHoy').value||0);
      $('rptMetaHoy').textContent = mH?money(mH):'‚Äî';
    }

    if(reportState.planYears!=null){
      $('rptPlazo').textContent = `${reportState.planYears} a√±os aportando`;
    }else{
      const y = parseFloat($('years').value||0);
      $('rptPlazo').textContent = y?`${y} a√±os aportando`:'‚Äî';
    }

    if(reportState.pmtSugerido!=null){
      $('rptAportSug').textContent = money(reportState.pmtSugerido);
    }else{
      const p = parseFloat($('pmt').value||0);
      $('rptAportSug').textContent = p?money(p):'‚Äî';
    }

    // Supuestos
    const infl = reportState.infl!=null?reportState.infl:parseFloat($('inflation').value||0);
    const rAcc = reportState.rAcc!=null?reportState.rAcc:parseFloat($('rate').value||0);
    const yrsRet = reportState.yrsRet!=null?reportState.yrsRet:parseInt($('yrsRetSel').value||20,10);
    const rRet = reportState.rRet!=null?reportState.rRet:parseFloat($('rateRet').value||7);

    $('rptSupuestos1').textContent =
      `Inflaci√≥n media anual ${infl.toFixed(1)}%, rendimiento anual en acumulaci√≥n ${rAcc.toFixed(1)}% nominal, `+
      `retiro estimado de ${yrsRet} a√±os con ${rRet.toFixed(1)}% nominal durante la etapa de retiro.`;

    // Fiscal
    if(reportState.regimenFiscal==='151' && reportState.isrPct>0 && reportState.benefFiscal>0){
      $('rptSupuestosFiscal').textContent =
        `Se asume que el plan se contrata bajo Art. 151 (deducible), con devoluci√≥n aproximada de ISR de ${reportState.isrPct.toFixed(0)}% `+
        `sobre la aportaci√≥n anual y reinversi√≥n total de dicha devoluci√≥n en el propio plan.`;
      $('rptFilaFiscal').style.display='table-row';
      $('rptBenefFiscal').textContent = money(reportState.benefFiscal);
    }else if(reportState.regimenFiscal==='93'){
      $('rptSupuestosFiscal').textContent =
        `Tratamiento bajo Art. 93 (no deducible en el corto plazo). No se modela devoluci√≥n anual de ISR en esta proyecci√≥n.`;
      $('rptFilaFiscal').style.display='none';
    }else{
      $('rptSupuestosFiscal').textContent =
        `No se considera beneficio fiscal inmediato sobre las aportaciones en esta proyecci√≥n.`;
      $('rptFilaFiscal').style.display='none';
    }

    // Tabla de acumulaci√≥n
    $('rptTotalAportado').textContent = reportState.totalAportado?money(reportState.totalAportado):'‚Äî';
    $('rptRendimiento').textContent   = reportState.rendimiento?money(reportState.rendimiento):'‚Äî';
    $('rptAhorroNominal').textContent = reportState.ahorroNominal?money(reportState.ahorroNominal):'‚Äî';
    $('rptFondo65').textContent       = reportState.fondo65?money(reportState.fondo65):'‚Äî';

    // Ingreso retiro
    $('rptIngresoMensual').textContent = reportState.ingresoMensual?money(reportState.ingresoMensual):'‚Äî';
    $('rptDuracion').textContent       = reportState.yrsRet?`${reportState.yrsRet} a√±os`:'‚Äî';
    $('rptTasaReal').textContent       = reportState.tasaRealMes?`${(reportState.tasaRealMes*100).toFixed(3)}% mensual`:'‚Äî';

    if(reportState.fondo65 && reportState.fondo65>0){
      const anual4 = reportState.fondo65*0.04;
      $('rptRegla4').textContent =
        `Como referencia prudente, la ‚Äúregla del 4%‚Äù sugiere un retiro anual de alrededor de ${money(anual4)} `+
        `(${money(anual4/12)} mensuales) para cuidar la probabilidad de que el capital alcance toda la etapa de retiro.`;
    }else{
      $('rptRegla4').textContent = '‚Äî';
    }

    // Comentario final r√°pido:
    const nombreShow = nombre || 'Tu plan';
    $('rptComentario').textContent =
      `${nombreShow} no necesita adivinar su futuro financiero: ahora tiene una gu√≠a num√©rica para tomar decisiones. `+
      `La recomendaci√≥n es revisar este plan en conjunto con Christian GarBa para afinar montos, horizonte y tipo de cobertura, `+
      `de modo que el ahorro sea realista y compatible con tus dem√°s proyectos de vida.`;

    actualizarSeccionPosponer();
  }

  // ---------- CSV ----------
  function exportCSV(){
    const rows=[['A√±o','Edad','Aportado ese a√±o (MXN)','Beneficio fiscal reinvertido (MXN)','Saldo al cierre (MXN)']];
    document.querySelectorAll('#tbody tr').forEach(tr=>{
      const t=[...tr.querySelectorAll('td')].map(td=>td.textContent.replace(/[^\d.,\-a-z√± ]/gi,''));
      rows.push(t);
    });
    const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a');
    const name=$('nombreOpt').value||'Proyeccion';
    const f=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob);
    a.download=`${name}_corrida_${f}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---------- Eventos ----------
  $('planBtn').addEventListener('click', ()=>{ calcSuggestion(); calcAccum(); });
  $('resetTop').addEventListener('click', ()=>{
    $('nombreOpt').value='';
    $('edadTop').value=29;
    $('planTop').value='25';
    $('metaHoy').value=32000;
    $('sugBox').style.display='none';
  });

  $('calcBtn').addEventListener('click', calcAccum);
  $('resetBtn').addEventListener('click', ()=>{
    $('edad').value=29; 
    $('years').value=25; 
    $('pmt').value=2500; 
    $('frequency').value=12; 
    $('lumpSum').value=0;
    $('rate').value=10; 
    $('inflation').value=4;
    $('regimenFiscal').value='ninguno';
    $('isrPct').value='20';
    $('reinvertISR').checked=true;
    calcAccum();
  });

  $('calcRet').addEventListener('click', calcRet);
  $('csvBtn').addEventListener('click', exportCSV);
  $('printBtn').addEventListener('click', ()=>{ window.print(); });

  $('toggleTable').addEventListener('click',()=>{
    const d=$('details');
    d.style.display=d.style.display==='block'?'none':'block';
  });
  $('toggleTableRet').addEventListener('click',()=>{
    const d=$('detailsRet');
    d.style.display=d.style.display==='block'?'none':'block';
  });

  ['edadTop','planTop','metaHoy','rate','inflation','rateRet','yrsRetSel'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcSuggestion(); });
  });
  ['edad','years','pmt','frequency','lumpSum','rate','inflation','regimenFiscal','isrPct','reinvertISR'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcAccum(); });
  });

  window.addEventListener('load', ()=>{
    calcSuggestion();
    calcAccum();
    linkWhatsApp();
    actualizarReporteBase();
  });
</script>
</body>
</html>
