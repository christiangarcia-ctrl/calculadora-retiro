<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#0B5ED7; --brand-2:#084cc3;
    --ink:#0f172a; --muted:#94a3b8;
    --paper:#111827; --panel:#0b1324; --line:rgba(255,255,255,.14);
    --wa:#25D366;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;
    font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
    background:radial-gradient(circle at 0 0,rgba(37,99,235,.25),transparent 55%),
               radial-gradient(circle at 100% 100%,rgba(56,189,248,.18),transparent 55%),
               linear-gradient(135deg,#020617,#020617);
    color:#e5e7eb
  }
  a{color:inherit;text-decoration:none}
  .container{max-width:1040px;margin:0 auto;padding:22px}

  /* Header */
  .header{
    background:#ffffff;
    border:1px solid #e5e7eb;
    border-radius:16px;
    padding:16px 18px;
    display:flex;
    align-items:center;
    gap:14px;
    box-shadow:0 8px 24px rgba(15,23,42,.16)
  }
  .brand img{height:56px;width:auto;display:block}
  .title{font-weight:800;font-size:22px;color:#0f172a}
  .sub{font-size:13px;color:#475569}
  .meta{margin-left:auto;text-align:right;font-size:14px;color:#111827;display:flex;gap:24px;flex-wrap:wrap;justify-content:flex-end}
  .meta span{display:flex;gap:8px;align-items:center}

  /* Toolbar */
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin:14px 0 18px;flex-wrap:wrap}
  .btn{
    appearance:none;
    border:1px solid #e5e7eb;
    background:#fff;
    color:#0f172a;
    padding:10px 14px;
    border-radius:10px;
    font-weight:700;
    cursor:pointer;
    transition:.2s
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,.10)}
  .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn-primary:hover{background:var(--brand-2)}

  /* Banner AFORE */
  .banner{
    background:#fff7ed;
    color:#7c2d12;
    border:1px solid #fed7aa;
    border-left:6px solid #fb923c;
    border-radius:14px;
    padding:14px 16px;
    margin:18px 0;
    box-shadow:0 4px 14px rgba(2,6,23,.12);
    font-size:14px;
    line-height:1.5;
  }
  .banner strong{color:#9a3412}

  /* Privacy badge */
  .privacy-badge{
    display:flex;
    align-items:flex-start;
    gap:10px;
    margin-bottom:10px;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(15,23,42,.85);
    border:1px solid rgba(148,163,184,.35);
  }
  .privacy-badge .icon{font-size:18px}
  .privacy-badge .text strong{font-size:13px}
  .privacy-badge .text p{margin:2px 0 0;font-size:12px;color:#cbd5e1}

  /* Cards */
  .card{
    background:rgba(15,23,42,.96);
    border:1px solid var(--line);
    border-radius:16px;
    padding:22px;
    margin:16px 0;
    box-shadow:0 10px 30px rgba(2,6,23,.6);
  }
  .card h2{margin:0 0 10px;color:#e5edff;font-size:20px;font-weight:800}
  .help{margin:-2px 0 14px;color:#cbd5e1;font-size:13px}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
  .group{display:flex;flex-direction:column}
  label{font-size:12px;color:#cbd5e1;margin-bottom:6px;font-weight:600}
  input,select{
    padding:12px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(15,23,42,.9);
    color:#fff;
    border-radius:10px;
    font-size:16px;
    transition:border .15s, box-shadow .15s
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(11,94,215,.35)
  }
  .muted{font-size:12px;color:#94a3b8;margin-top:6px}

  /* Suggestion */
  .suggest{
    display:none;
    border:1px solid rgba(56,189,248,.45);
    background:radial-gradient(circle at 0 0,rgba(56,189,248,.18),transparent 60%);
    border-left:6px solid #0ea5e9;
    border-radius:14px;
    padding:14px;
    margin-top:12px;
    font-size:14px;
  }
  .suggest strong{color:#e0f2fe}

  /* KPIs */
  .kpis{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:12px;
    margin-top:6px
  }
  .kpi{
    background:rgba(15,23,42,1);
    border:1px solid rgba(148,163,184,.45);
    border-radius:14px;
    padding:16px
  }
  .kpi-label{font-size:11px;letter-spacing:.4px;color:#a9b4c7;text-transform:uppercase}
  .kpi-value{font-size:22px;font-weight:800;color:#f8fafc}

  /* Details tables */
  .toggle{
    display:flex;
    justify-content:space-between;
    align-items:center;
    cursor:pointer;
    border:1px solid var(--line);
    padding:12px 14px;
    border-radius:12px;
    margin-top:12px;
    background:rgba(15,23,42,.9);
  }
  .details{display:none;overflow:auto}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th{
    background:rgba(15,23,42,.98);
    text-align:left;
    padding:10px;
    border-bottom:1px solid rgba(148,163,184,.45);
    font-size:13px;
    position:sticky;
    top:0;
  }
  td{
    padding:10px;
    border-bottom:1px solid rgba(51,65,85,.8);
    font-size:14px;
  }

  /* WhatsApp */
  .wa{
    position:fixed;
    right:18px;
    bottom:22px;
    background:var(--wa);
    color:#06371a;
    border-radius:999px;
    padding:12px 16px;
    font-weight:800;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    text-decoration:none;
    font-size:14px;
  }

  .error{
    display:none;
    background:rgba(220,53,69,.18);
    border:1px solid rgba(220,53,69,.4);
    color:#fecaca;
    padding:10px;
    border-radius:10px;
    margin:8px 0
  }

  /* Completion block */
  .completion{
    display:none;
    margin-top:16px;
    padding:18px 18px 16px;
    border-radius:16px;
    border:1px solid rgba(34,197,94,.4);
    background:linear-gradient(135deg,rgba(22,163,74,.2),rgba(15,23,42,.95));
  }
  .completion-title{margin:0 0 8px;font-size:20px;font-weight:800;color:#bbf7d0}
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(34,197,94,.18);
    border:1px solid rgba(34,197,94,.5);
    font-size:12px;
  }
  .completion-actions{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px}
  .btn-soft{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.5);
    background:rgba(15,23,42,.9);
    color:#e5e7eb;
    padding:8px 12px;
    cursor:pointer;
    font-size:13px;
  }

  /* Print */
  @media print{
    .wa,.toolbar,.toggle{display:none!important}
    body{background:#fff;color:#000}
    .card{box-shadow:none;border-color:#e5e7eb;background:#fff;color:#0f172a}
    .kpi{background:#f9fafb;border-color:#e5e7eb}
    td,th{border-color:#e5e7eb;background:#fff;color:#111827}
  }
</style>
</head>
<body>
  <div class="container">

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn" id="csvBtn">Exportar CSV</button>
      <button class="btn btn-primary" id="printBtn">Imprimir / Guardar PDF</button>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="brand"><img src="./logo-garba.png" alt="Christian GarBa"></div>
      <div>
        <div class="title">Christian GarBa</div>
        <div class="sub">Seguros con Estrategia</div>
      </div>
      <div class="meta">
        <span>üìû 662 417 6032</span>
        <span>‚úâÔ∏è christian.garcia@sfgarba.com.mx</span>
      </div>
    </div>

    <!-- Privacy badge -->
    <div class="privacy-badge">
      <span class="icon">üîí</span>
      <div class="text">
        <strong>100% privado</strong>
        <p>Los c√°lculos se realizan en tu navegador. Nada se env√≠a a ning√∫n servidor.</p>
      </div>
    </div>

    <!-- Banner AFORE -->
    <div class="banner">
      <strong>¬øAFORE (Ley ‚Äò97 en adelante)?</strong> Tu AFORE no ser√° suficiente <em>(y lo sabes)</em>. Empezar <u>hoy</u> tu ahorro adicional
      marca la diferencia: cuanto antes inicies, <strong>menos tendr√°s que aportar</strong> para lograr el mismo ingreso y m√°s tranquilidad al llegar a los 65.
    </div>

    <!-- Panel A -->
    <div class="card">
      <h2>Panel A ¬∑ Ahorro hasta los 65</h2>
      <div class="help">La edad de retiro considerada es <strong>65 a√±os</strong>. Si tu plan termina antes, el fondo sigue invirti√©ndose hasta esa edad.</div>
      <div class="grid">
        <div class="group">
          <label for="nombreOpt">Tu nombre (opcional)</label>
          <input id="nombreOpt" type="text" placeholder="Ej. Fernanda">
        </div>
        <div class="group">
          <label for="edadTop">Edad actual (a√±os)</label>
          <input id="edadTop" type="number" min="18" max="100" value="29">
        </div>
        <div class="group">
          <label for="planTop">A√±os de plan</label>
          <select id="planTop">
            <option value="15">15 a√±os</option>
            <option value="20">20 a√±os</option>
            <option value="25" selected>25 a√±os</option>
          </select>
        </div>
        <div class="group" style="grid-column:1/-1">
          <label for="metaHoy">¬øCu√°nto te gustar√≠a recibir al mes en tu retiro? (MXN, valor de hoy)</label>
          <input id="metaHoy" type="number" min="0" step="1000" placeholder="Ej. 32,000" value="32000">
          <div class="muted">Usamos este dato para sugerirte un ahorro mensual inicial realista (tu aporte crece cada a√±o ‚âà inflaci√≥n).</div>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="planBtn">Calcular mi plan personalizado</button>
        <button class="btn" id="resetTop">Reiniciar datos</button>
      </div>

      <!-- Proyecci√≥n personalizada -->
      <div class="suggest" id="sugBox">
        <div id="sugText"></div>
        <div class="muted" id="sugSup"></div>
      </div>
    </div>

    <!-- Fase 1 -->
    <div class="card">
      <h2>Fase 1 ‚Ä¢ Ahorro con inter√©s compuesto</h2>
      <p class="help">Las aportaciones se actualizan autom√°ticamente cada a√±o con la inflaci√≥n promedio que definas.</p>
      <div class="error" id="errorMsg"></div>
      <div class="grid">
        <div class="group">
          <label for="edad">Edad actual (a√±os)</label>
          <input id="edad" type="number" value="29" min="18" max="100">
        </div>
        <div class="group">
          <label for="years">A√±os que aportar√°</label>
          <input id="years" type="number" value="25" min="1" max="70">
        </div>
        <div class="group">
          <label for="pmt">Aportaci√≥n peri√≥dica inicial (MXN)</label>
          <input id="pmt" type="number" value="2500" min="0" step="0.01">
          <div class="muted">Se incrementa cada a√±o ‚âà inflaci√≥n.</div>
        </div>
        <div class="group">
          <label for="frequency">Frecuencia de aportaci√≥n</label>
          <select id="frequency">
            <option value="12" selected>Mensual</option>
            <option value="4">Trimestral</option>
            <option value="2">Semestral</option>
            <option value="1">Anual</option>
          </select>
        </div>
        <div class="group">
          <label for="lumpSum">Aportaci√≥n inicial (MXN)</label>
          <input id="lumpSum" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="rate">Rendimiento anual esperado (nominal, %)</label>
          <input id="rate" type="number" value="10" min="0" max="100" step="0.01">
        </div>
        <div class="group">
          <label for="inflation">Inflaci√≥n promedio anual (%)</label>
          <input id="inflation" type="number" value="4" min="0" max="100" step="0.01">
        </div>
        <div class="group" style="grid-column:1/-1">
          <label style="display:flex;align-items:center;gap:8px;font-weight:600">
            <input id="useTax" type="checkbox" style="width:auto;margin:0">
            Incluir est√≠mulo fiscal (plan deducible)
          </label>
          <div class="muted">Opcional y educativo. Calcula una devoluci√≥n estimada de ISR sobre tus aportaciones.</div>
        </div>
        <div class="group" id="taxOpts" style="display:none">
          <label for="taxRate">Porcentaje estimado de devoluci√≥n sobre tus aportaciones (%)</label>
          <input id="taxRate" type="number" value="20" min="0" max="35" step="0.1">
          <label style="margin-top:8px;display:flex;align-items:center;gap:8px;font-weight:400">
            <input id="reinvestTax" type="checkbox" checked style="width:auto;margin:0">
            Reinvertir devoluci√≥n cada a√±o en el mismo plan
          </label>
          <div class="muted">Ejemplo: si aportas $50,000 al a√±o y la devoluci√≥n es 20%, el SAT te regresar√≠a ‚âà $10,000.</div>
        </div>
      </div>

      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcBtn">Calcular</button>
        <button class="btn" id="resetBtn">Limpiar</button>
      </div>
    </div>

    <!-- Resultados Fase 1 -->
    <div class="card">
      <h2>Resultados de la Fase 1</h2>
      <div class="kpis">
        <div class="kpi"><div class="kpi-label">Edad al finalizar aportaciones</div><div class="kpi-value" id="edadFinal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Ahorro acumulado al fin de aportaciones</div><div class="kpi-value" id="ahorroNominal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Fondo a los 65</div><div class="kpi-value" id="fondo65">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Total aportado por ti</div><div class="kpi-value" id="totalAportado">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Est√≠mulo fiscal estimado</div><div class="kpi-value" id="estimuloFiscal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Rendimiento financiero</div><div class="kpi-value" id="rendimiento">‚Äî</div></div>
      </div>

      <div class="toggle" id="toggleTable">
        <span><strong>Detalles a√±o por a√±o</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="details">
        <table>
          <thead>
            <tr>
              <th>A√±o</th>
              <th>Edad</th>
              <th>Aportado ese a√±o</th>
              <th>Est√≠mulo fiscal a√±o</th>
              <th>Saldo al cierre</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Fase 2 -->
    <div class="card">
      <h2>Fase 2 ‚Ä¢ Mensualidad de retiro</h2>
      <p class="help">
        La mensualidad se calcula en <strong>valor nominal (futuro)</strong> a partir del fondo a los 65.
        Puedes elegir entre una renta <strong>fija</strong> o una renta que <strong>sube cada a√±o ‚âà inflaci√≥n</strong>.
      </p>
      <div class="grid">
        <input type="hidden" id="pvRet" value="0">
        <div class="group">
          <label for="yrsRetSel">A√±os de retiro</label>
          <select id="yrsRetSel">
            <option value="15">15 a√±os</option>
            <option value="20" selected>20 a√±os</option>
            <option value="25">25 a√±os</option>
          </select>
        </div>
        <div class="group">
          <label for="rateRet">Rendimiento anual durante retiro (nominal, %)</label>
          <input id="rateRet" type="number" value="7" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="inflRet">Inflaci√≥n esperada (%)</label>
          <input id="inflRet" type="number" value="4" min="0" step="0.01">
        </div>
        <div class="group">
          <label for="retMode">Tipo de retiro</label>
          <select id="retMode">
            <option value="fixed" selected>Mensualidad fija (no crece)</option>
            <option value="indexed">Mensualidad que sube cada a√±o ‚âà inflaci√≥n</option>
          </select>
          <div class="muted">La opci√≥n indexada mantiene mejor tu poder adquisitivo.</div>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-start">
        <button class="btn btn-primary" id="calcRet">Calcular mensualidad</button>
      </div>

      <div class="kpis" id="retBox" style="display:none">
        <div class="kpi"><div class="kpi-label">Ingreso mensual estimado</div><div class="kpi-value" id="pmtReal">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Meses de retiro</div><div class="kpi-value" id="nMeses">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Tasa real mensual</div><div class="kpi-value" id="iRealMes">‚Äî</div></div>
        <div class="kpi"><div class="kpi-label">Regla 4% (referencia anual)</div><div class="kpi-value" id="rule4">‚Äî</div></div>
      </div>

      <!-- Detalle mensual del retiro -->
      <div class="toggle" id="toggleTableRet">
        <span><strong>Detalle mensual del retiro</strong></span><span>‚ñº</span>
      </div>
      <div class="details" id="detailsRet">
        <table>
          <thead>
            <tr>
              <th>Mes</th>
              <th>Edad</th>
              <th>Retiro del mes</th>
              <th>Inter√©s del mes</th>
              <th>Saldo al cierre</th>
            </tr>
          </thead>
          <tbody id="tbodyRet"></tbody>
        </table>
      </div>

      <!-- Bloque de ‚Äúplan completado‚Äù -->
      <div class="completion" id="completionBox">
        <h3 class="completion-title">üéâ ¬°Plan completado!</h3>
        <div class="badge">üèÜ Planificador inteligente</div>
        <p class="muted" id="completionSummary" style="margin-top:8px"></p>

        <div class="completion-actions">
          <button class="btn-soft" id="btnPrint2">üìÑ Imprimir / Guardar PDF</button>
          <button class="btn-soft" id="btnEmailPlan">üìß Enviarme resumen por correo</button>
          <button class="btn-soft" id="btnSendToChris">üí¨ Envi√°rselo a Christian</button>
          <button class="btn-soft" id="btnShareTool">üîó Compartir la herramienta (sin datos)</button>
        </div>
        <p class="muted" style="margin-top:8px">
          Si compartes, solo se comparte la herramienta, <strong>no</strong> tus n√∫meros.
        </p>
      </div>
    </div>

    <div class="muted">Proyecci√≥n educativa; no contempla impuestos, comisiones u otros costos reales del producto. Resultados no garantizados.</div>
  </div>

  <!-- WhatsApp -->
  <a id="waBtn" class="wa" target="_blank" rel="noopener">Chatear por WhatsApp</a>

<script>
  // -------------------- Utilidades
  const $ = id => document.getElementById(id);
  const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN'}).format(Number(v)||0);

  function linkWhatsApp(){
    const nombre = ($('nombreOpt').value||'').trim();
    const msg = [
      'Hola Christian, me interesa revisar mi plan de retiro.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos aproximados:*',
      `‚Ä¢ Edad: ${$('edad').value} a√±os`,
      `‚Ä¢ A√±os de aportaci√≥n: ${$('years').value}`,
      `‚Ä¢ Aportaci√≥n ${({'12':'mensual','4':'trimestral','2':'semestral','1':'anual'})[$('frequency').value]}: ${money($('pmt').value)}`,
      `‚Ä¢ Fondo proyectado a los 65: ${$('fondo65').textContent}`
    ].filter(Boolean).join('\\n');
    $('waBtn').href = 'https://wa.me/526624176032?text='+encodeURIComponent(msg);
  }

  // -------------------- Sugerencia PMT inicial (nominal a 65)
  function calcSuggestion(){
    const edad    = parseFloat($('edadTop').value);
    const planY   = parseInt($('planTop').value,10);
    const metaHoy = parseFloat($('metaHoy').value||0);

    const infl    = parseFloat($('inflation').value)/100;
    const rAcc    = parseFloat($('rate').value)/100;
    const rRet    = parseFloat($('rateRet').value)/100;
    const yrsRet  = parseInt($('yrsRetSel').value,10);
    const freq    = 12;

    if(!(edad>0 && planY>0 && metaHoy>0)){ $('sugBox').style.display='none'; return; }

    const yrsTo65   = Math.max(0, 65 - edad);
    const metaNom65 = metaHoy * Math.pow(1+infl, yrsTo65);

    const iRet = rRet/freq, nRet = yrsRet*freq;
    const PVneed65 = Math.abs(iRet)<1e-12 ? metaNom65*nRet
                      : metaNom65 * ( (1 - Math.pow(1+iRet, -nRet)) / iRet );

    const yrsTo65Real = yrsTo65;
    const yrsAport    = Math.min(planY, yrsTo65Real);
    const gapYears    = Math.max(0, yrsTo65Real - yrsAport);

    // Factor de aportaciones crecientes (1 unidad de PMT inicial)
    const iAcc = rAcc/freq;
    const N    = yrsAport*freq;
    let FV_pagos = 0, pmtYear = 1;
    for(let y=0; y<yrsAport; y++){
      if(y>0) pmtYear *= (1+infl);
      for(let m=0; m<freq; m++){
        const perRest = N - (y*freq + m);
        FV_pagos += pmtYear * Math.pow(1+iAcc, perRest);
      }
    }
    const growTo65    = Math.pow(1+iAcc, gapYears*freq);
    const totalFactor = FV_pagos * growTo65;
    const PMT_inicial = totalFactor>0 ? PVneed65 / totalFactor : 0;

    const yrsTexto = gapYears>0 ? ` Tu fondo seguir√≠a creciendo ${gapYears} a√±o(s) m√°s hasta los 65.` : '';
    $('sugText').innerHTML =
      `üí° <strong>Proyecci√≥n personalizada:</strong> para lograr el ingreso que buscas en tu retiro, `+
      `un <strong>ahorro mensual inicial de ${money(PMT_inicial.toFixed(2))}</strong> ser√≠a un buen punto de partida.`+
      `<br><span style="font-size:12px;color:#cfd8e3">Es una gu√≠a; puedes iniciar desde $2,500 MXN/mes. `+
      `Lo importante es empezar.${yrsTexto}</span>`;
    $('sugSup').innerText =
      `Supuestos: inflaci√≥n ${(infl*100).toFixed(1)}%, acumulaci√≥n ${(rAcc*100).toFixed(1)}% nominal, `+
      `retiro ${yrsRet} a√±os con ${(rRet*100).toFixed(1)}% nominal.`;
    $('sugBox').style.display='block';

    // Precarga Fase 1
    $('edad').value  = String(edad);
    $('years').value = String(planY);
    $('pmt').value   = String(PMT_inicial.toFixed(2));
  }

  // -------------------- Fase 1 (simulaci√≥n a√±o a a√±o, con est√≠mulo fiscal opcional)
  function calcAccum(){
    const edad = parseFloat($('edad').value);
    const years = parseFloat($('years').value);
    const pmt0 = parseFloat($('pmt').value);
    const lump = parseFloat($('lumpSum').value);
    const rate = parseFloat($('rate').value)/100;
    const freq = parseFloat($('frequency').value);
    const infl = parseFloat($('inflation').value)/100;
    const useTax = $('useTax').checked;
    const taxRate = parseFloat($('taxRate')?.value || '0')/100;
    const reinvestTax = $('reinvestTax')?.checked ?? false;

    if([edad,years,pmt0,lump,rate,freq,infl].some(x=>isNaN(x))){
      const e=$('errorMsg'); e.textContent='Completa todos los campos correctamente.'; e.style.display='block'; return;
    } else { $('errorMsg').style.display='none'; }

    const totalYears = Math.max(years, 65-edad);
    const i = rate/freq;

    let saldo = lump;                 // saldo actual
    let totalContrib = lump;          // aportado por la persona
    let totalTax = 0;                 // est√≠mulo fiscal acumulado
    let edadAct = edad;
    let pmtYear = pmt0;
    let FV_endContrib = lump;

    const tbody=$('tbody'); tbody.innerHTML='';

    for(let yr=1; yr<=totalYears; yr++){
      edadAct++;
      // actualizar PMT del a√±o (crece con inflaci√≥n mientras haya aportaciones)
      if(yr>1 && yr<=years) pmtYear *= (1+infl);

      let aportAnual = 0;
      for(let m=0; m<freq; m++){
        saldo = saldo*(1+i);
        if(yr<=years){
          saldo += pmtYear;
          aportAnual += pmtYear;
          totalContrib += pmtYear;
        }
      }

      // est√≠mulo fiscal al cierre del a√±o
      let taxYear = 0;
      if(useTax && yr<=years && taxRate>0){
        taxYear = aportAnual * taxRate;
        totalTax += taxYear;
        if(reinvestTax){
          saldo += taxYear; // se reinvierte al final del a√±o
        }
      }

      if(yr===years){
        FV_endContrib = saldo;
      }

      const tr=document.createElement('tr');
      if(yr>years){
        tr.style.background='rgba(37,99,235,.10)';
      }
      tr.innerHTML =
        `<td>${yr}</td>`+
        `<td>${edadAct} a√±os</td>`+
        `<td>${yr>years ? '‚Äî' : money(aportAnual)}</td>`+
        `<td>${taxYear>0 ? money(taxYear) : '‚Äî'}</td>`+
        `<td>${money(saldo)}</td>`;
      tbody.appendChild(tr);
    }

    const fondo65 = saldo;
    const totalUsuario = totalContrib; // lump ya incluido
    const baseCapital = totalUsuario + (reinvestTax ? totalTax : 0);
    const rendimiento = fondo65 - baseCapital;

    $('edadFinal').textContent = String(Math.round(edad + years));
    $('ahorroNominal').textContent = money(FV_endContrib);
    $('fondo65').textContent = money(fondo65);
    $('totalAportado').textContent = money(totalUsuario);
    $('estimuloFiscal').textContent = totalTax>0 ? money(totalTax) : '‚Äî';
    $('rendimiento').textContent = money(rendimiento);

    $('pvRet').value = String(fondo65);
    linkWhatsApp();
  }

  // -------------------- Fase 2 (retiro desde saldo a 65)
  function calcRet(){
    const PV = parseFloat($('pvRet').value)||0;
    const yrs = parseInt($('yrsRetSel').value,10);
    const rateRet = parseFloat($('rateRet').value)/100;
    const infl = parseFloat($('inflRet').value)/100;
    const mode = $('retMode').value || 'fixed';

    if(PV<=0){ alert('Primero calcula tu ahorro (Fase 1).'); return; }

    const n = yrs*12;
    const iNom = rateRet/12;

    let PMT, labelPmt;
    const rReal = ((1+rateRet)/(1+infl))-1;
    const iReal = rReal/12;

    if(mode === 'fixed'){
      // renta fija nominal
      PMT = Math.abs(iNom)<1e-9 ? PV/n : PV * ( iNom / (1 - Math.pow(1+iNom,-n)) );
      labelPmt = money(PMT);
    }else{
      // renta que crece con la inflaci√≥n cada a√±o (f√≥rmula anual)
      const iA = rateRet;
      const g = infl;
      const N = yrs;
      let P1;
      if(Math.abs(iA-g)<1e-9){
        P1 = PV / N;
      }else{
        const factor = 1 - Math.pow((1+g)/(1+iA), N);
        P1 = PV * ( (iA - g) / factor );
      }
      PMT = P1/12; // mensual primer a√±o
      labelPmt = `${money(PMT)} (a√±o 1)`;
    }

    $('retBox').style.display='grid';
    $('pmtReal').textContent = labelPmt;
    $('nMeses').textContent = `${n} meses`;
    $('iRealMes').textContent = isFinite(iReal) ? `${(iReal*100).toFixed(3)}%` : '‚Äî';
    $('rule4').textContent = `${money(PV*0.04)} /a√±o ¬∑ ${money(PV*0.04/12)} /mes`;

    // Detalle mensual
    const tbodyRet = $('tbodyRet'); tbodyRet.innerHTML='';
    let saldo = PV;
    for(let m=1; m<=n; m++){
      const yearIndex = Math.floor((m-1)/12); // 0..yrs-1
      const pagoMes = (mode==='fixed') ? PMT : PMT * Math.pow(1+infl, yearIndex);
      const interes = saldo * iNom;
      const saldoAntes = saldo + interes;
      const saldoDesp = Math.max(0, saldoAntes - pagoMes);

      const yearsAdd = Math.floor((m-1)/12);
      const monthsRem = (m-1)%12;
      const edadTxt = `${65 + yearsAdd} a√±os${monthsRem?` ${monthsRem} mes(es)`:''}`;

      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${m}</td>`+
        `<td>${edadTxt}</td>`+
        `<td>${money(pagoMes)}</td>`+
        `<td>${money(interes)}</td>`+
        `<td>${money(saldoDesp)}</td>`;
      tbodyRet.appendChild(tr);

      saldo = saldoDesp;
    }

    // Bloque de plan completado
    const summary = [
      `Edad actual: ${$('edad').value} a√±os`,
      `A√±os de ahorro: ${$('years').value}`,
      `Aportaci√≥n inicial: ${money($('pmt').value)}`,
      `Fondo estimado a los 65: ${money(PV)}`,
      `Tipo de retiro: ${mode==='fixed'?'mensualidad fija':'mensualidad indexada a inflaci√≥n'}`
    ].join(' ¬∑ ');
    $('completionSummary').textContent = summary;
    $('completionBox').style.display = 'block';
  }

  // -------------------- CSV (Fase 1)
  function exportCSV(){
    const rows=[['A√±o','Edad','Aportado ese a√±o (MXN)','Est√≠mulo fiscal a√±o (MXN)','Saldo al cierre (MXN)']];
    document.querySelectorAll('#tbody tr').forEach(tr=>{
      const t=[...tr.querySelectorAll('td')].map(td=>td.textContent.replace(/\\$/g,''));
      rows.push(t);
    });
    const blob=new Blob([rows.map(r=>r.join(',')).join('\\n')],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); const name=$('nombreOpt').value||'Proyeccion', f=new Date().toISOString().slice(0,10);
    a.href=URL.createObjectURL(blob); a.download=`${name}_corrida_${f}.csv`; a.click(); URL.revokeObjectURL(a.href);
  }

  // -------------------- Compartir herramienta (sin datos)
  function shareToolOnly(){
    const baseText =
      'Encontr√© una calculadora de retiro que te arma un plan con datos de M√©xico.\\n\\n'+
      'Es gratis y tus n√∫meros se quedan privados.\\n\\n'+
      'Haz tu propio c√°lculo aqu√≠: https://garba.tools';
    if(navigator.share){
      navigator.share({text:baseText}).catch(()=>{});
    }else{
      navigator.clipboard?.writeText(baseText);
      alert('Texto copiado. P√©galo en WhatsApp o en tu red social favorita.');
    }
  }

  // -------------------- Email resumen (mailto)
  function emailPlan(){
    const nombre = ($('nombreOpt').value||'').trim() || 'Futuro inversionista';
    const asunto = 'Tu Plan de Retiro Personalizado - GarBa';
    const body =
`Hola ${nombre},

Aqu√≠ est√° el resumen de tu simulaci√≥n de retiro generada hoy ${new Date().toLocaleDateString('es-MX')}.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìä TU PLAN RESUMIDO

Edad actual: ${$('edad').value} a√±os
A√±os de ahorro: ${$('years').value}
Aportaci√≥n inicial: ${money($('pmt').value)}
Fondo estimado a los 65: ${$('fondo65').textContent}

Tipo de retiro elegido: ${$('retMode').value==='fixed'?'mensualidad fija':'mensualidad que sube cada a√±o ‚âà inflaci√≥n'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Este correo es solo una referencia educativa. Si quieres que ajustemos el plan con un producto real:

üìû 662 417 6032
üí¨ WhatsApp: https://wa.me/526624176032
üìß christian.garcia@sfgarba.com.mx

Christian GarBa
Seguros con Estrategia
`;
    const mailto = `mailto:?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailto;
  }

  // -------------------- Eventos
  $('planBtn').addEventListener('click', ()=>{ calcSuggestion(); calcAccum(); });
  $('resetTop').addEventListener('click', ()=>{
    $('nombreOpt').value=''; $('edadTop').value=29; $('planTop').value='25'; $('metaHoy').value=32000;
    $('sugBox').style.display='none';
  });

  $('calcBtn').addEventListener('click', calcAccum);
  $('resetBtn').addEventListener('click', ()=>{
    $('edad').value=29; $('years').value=25; $('pmt').value=2500; $('frequency').value=12; $('lumpSum').value=0;
    $('rate').value=10; $('inflation').value=4; $('useTax').checked=false; $('taxOpts').style.display='none';
    calcAccum();
  });

  $('useTax').addEventListener('change', ()=>{
    $('taxOpts').style.display = $('useTax').checked ? 'block' : 'none';
    calcAccum();
  });

  $('taxRate').addEventListener('change', calcAccum);
  $('reinvestTax').addEventListener('change', calcAccum);

  $('calcRet').addEventListener('click', calcRet);
  $('csvBtn').addEventListener('click', exportCSV);
  $('printBtn').addEventListener('click', ()=>{ window.print(); });
  $('btnPrint2').addEventListener('click', ()=>{ window.print(); });
  $('toggleTable').addEventListener('click',()=>{ const d=$('details'); d.style.display=d.style.display==='block'?'none':'block'; });
  $('toggleTableRet').addEventListener('click',()=>{ const d=$('detailsRet'); d.style.display=d.style.display==='block'?'none':'block'; });

  $('btnEmailPlan').addEventListener('click', emailPlan);
  $('btnSendToChris').addEventListener('click', ()=>{ linkWhatsApp(); window.open($('waBtn').href,'_blank'); });
  $('btnShareTool').addEventListener('click', shareToolOnly);

  ['edadTop','planTop','metaHoy','rate','inflation','rateRet','yrsRetSel'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcSuggestion(); });
  });
  ['edad','years','pmt','frequency','lumpSum','rate','inflation'].forEach(id=>{
    $(id).addEventListener('change', ()=>{ calcAccum(); });
  });

  window.addEventListener('load', ()=>{ calcSuggestion(); calcAccum(); linkWhatsApp(); });
</script>
</body>
</html>
